[{"id":"807487aa.61868","type":"tab","label":"Tiendar.io - Tienda","disabled":false,"info":""},{"id":"e61c260d.1c787","type":"tab","label":"HolaMudo","disabled":true,"info":""},{"id":"492da878.144","type":"tab","label":"Ejemplo get/post","disabled":true,"info":""},{"id":"85ae90a6.827ac8","type":"tab","label":"Cosas viejas","disabled":true,"info":""},{"id":"d6e86490.4f832","type":"tab","label":"Validaciones","disabled":true,"info":""},{"id":"7d55cb03.a65684","type":"inject","z":"e61c260d.1c787","name":"","topic":"","payload":"container","payloadType":"global","repeat":"","crontab":"","once":false,"x":231.5,"y":155,"wires":[["34477a5d.5dc306"]]},{"id":"392f0757.97262","type":"debug","z":"e61c260d.1c787","name":"","active":false,"console":"false","complete":"payload","x":650,"y":160,"wires":[]},{"id":"34477a5d.5dc306","type":"function","z":"e61c260d.1c787","name":"InitContainer","func":"function Container(id, name) {\n    return {'id': id, 'name': name}\n}\n\nmsg.payload = Container(0, 'Pato')\nreturn msg;","outputs":1,"noerr":0,"x":430,"y":300,"wires":[["2f4498f8.3905d8","cac00910.a8a9b8"]]},{"id":"2f4498f8.3905d8","type":"xml","z":"e61c260d.1c787","name":"","attr":"","chr":"","x":501.5,"y":194,"wires":[["392f0757.97262","c7638cbc.16615"]]},{"id":"c7638cbc.16615","type":"xml","z":"e61c260d.1c787","name":"","attr":"","chr":"","x":678.5,"y":260,"wires":[["df505b6c.25d8e","dffcaf28.520be"]]},{"id":"178eb72f.445879","type":"debug","z":"e61c260d.1c787","name":"","active":true,"console":"false","complete":"false","x":910,"y":300,"wires":[]},{"id":"85f785ff.2e2158","type":"http request","z":"e61c260d.1c787","name":"","method":"GET","ret":"txt","url":"","tls":"","x":430,"y":420,"wires":[["1d4468de.c6e6af"]]},{"id":"af7edfeb.c06e28","type":"inject","z":"e61c260d.1c787","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"x":120.5,"y":376,"wires":[["4f1c6972.097d38"]]},{"id":"4f1c6972.097d38","type":"change","z":"e61c260d.1c787","name":"","rules":[{"t":"set","p":"url","pt":"msg","to":"www.google.es","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":206.5,"y":475,"wires":[["85f785ff.2e2158"]]},{"id":"1d4468de.c6e6af","type":"debug","z":"e61c260d.1c787","name":"","active":true,"console":"false","complete":"false","x":623.5,"y":438,"wires":[]},{"id":"df505b6c.25d8e","type":"function","z":"e61c260d.1c787","name":"","func":"function Container(id, name) {\n    return {'id': id, 'name': name}\n}\n\nvar container\nfor (var key in msg.payload)\n{\n    if (msg.payload.hasOwnProperty(key)) {           \n        ct = msg.payload[key];\n        container = Container(ct['id'][0], ct['name'][0])\n    }\n    \n}\n\n//container = Container(msg.payload['root']['id'][0], msg.payload['root']['name'][0])\n\nmsg.payload = container\nreturn msg;","outputs":1,"noerr":0,"x":754,"y":332,"wires":[["178eb72f.445879"]]},{"id":"1ec798de.b0bdbf","type":"debug","z":"e61c260d.1c787","name":"","active":false,"console":"false","complete":"false","x":990,"y":200,"wires":[]},{"id":"dffcaf28.520be","type":"function","z":"e61c260d.1c787","name":"","func":"msg.payload = msg.payload['root']\nreturn msg;","outputs":1,"noerr":0,"x":797,"y":214,"wires":[["1ec798de.b0bdbf"]]},{"id":"cac00910.a8a9b8","type":"debug","z":"e61c260d.1c787","name":"","active":false,"console":"false","complete":"false","x":603,"y":364,"wires":[]},{"id":"ffbe4a3f.cedf3","type":"http in","z":"e61c260d.1c787","name":"","url":"/hello","method":"get","upload":false,"swaggerDoc":"","x":160,"y":620,"wires":[["fea7fdb8.4b052","d5b01b7d.d313"]]},{"id":"fea7fdb8.4b052","type":"debug","z":"e61c260d.1c787","name":"","active":true,"console":"false","complete":"false","x":400,"y":581,"wires":[]},{"id":"d5b01b7d.d313","type":"http response","z":"e61c260d.1c787","name":"","statusCode":"","headers":{},"x":670,"y":680,"wires":[]},{"id":"8ab806cd.37f32","type":"inject","z":"807487aa.61868","name":"Init","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":true,"x":168.5714111328125,"y":285.7142791748047,"wires":[["82686b7e.7a183"]]},{"id":"82686b7e.7a183","type":"function","z":"807487aa.61868","name":"Init Container","func":"// Los clientes deben tener identificador y la lista de tiendas en las que han estado\n// De las tiendas se tiene la ip o hostname y puerto si es necesario, y el tipo\nclass Shop {\n    constructor(forum, lproducts){\n        this.type = \"js\"; // shop type to send and receive\n        this.products = {}; // Products dictionary inizalizer\n        this.forum = forum; // shop avalaible space for clients\n        this.isOpen = true; // shop initial state\n        this.clientes = {}; // Client list, index by idCliente, stores {'idTienda': {direccion: 'd', tipo: 'php/py/js'}, ...}\n        \n        for(let i = 0; i < lproducts.length; i++){\n            this.products[lproducts[i].nombre] = lproducts[i].cantidad;\n        }\n    }\n    \n    isFull(){\n        return Object.keys(this.clientes).length >= this.forum;\n    }\n    \n    // A client makes a petition to know other shops\n    knownShops(clientID){\n        var kshops = []; // [{idTienda: 'a', direccion: 'd', tipo: 'php/py/js'}, ...]\n        var auxshops = {};\n        \n        for (let client in this.clientes) {\n            if (client !== clientID)\n            {\n                auxshops = Object.assign({}, this.clientes[client], auxshops);\n            }\n        }\n        \n        for (let shop in auxshops) {\n            kshops.push({idTienda: shop, direccion: auxshops[shop].direccion, tipo: auxshops[shop].tipo});\n        }\n        \n        return kshops;\n    }\n    \n    isInside(clientID) {\n        return this.clientes[clientID] !== undefined;\n    }\n    \n    clientJoin(idCliente, kshops) {\n        var dshops = {};\n        \n        for(let i = 0; i < kshops.length; i++){\n            dshops[kshops[i].idTienda] = {direccion: kshops[i].direccion, tipo: kshops[i].tipo};\n        }\n        \n        this.clientes[idCliente] = dshops;\n    }\n    \n    clientLeave(idCliente) {\n        delete this.clientes[idCliente];\n    }\n    \n    // client petition to buy some items\n    sellItems(list_products){ // [{nombre: 'a', cantidad: n}, ..., {nombre: 'z', cantidad: m}]\n        var newlist = [];\n        \n        // iterate client list\n        for(let i = 0; i < list_products.length; i++){\n            if(this.products[list_products[i].nombre] !== undefined){\n                var ns = Math.max(this.products[list_products[i].nombre] - list_products[i].cantidad, 0);\n                \n                newlist.push({nombre: list_products[i].nombre, cantidad: this.products[list_products[i].nombre] - ns});\n                \n                this.products[list_products[i].nombre] = ns;\n                if (ns === 0) {\n                    delete this.products[list_products[i].nombre];\n                }\n            }\n        }\n        \n        if (Object.keys(this.products).length === 0) {\n            this.isOpen = false;\n        }\n        \n        return newlist;\n    }\n}\n\nflow.set(\"direccion\", 'http://clanjhoo.com:1880/');\nflow.set(\"Shop\",Shop);\nflow.set(\"shopDict\", {});\nflow.set(\"lmesTS\", {});\n\nreturn msg;","outputs":1,"noerr":0,"x":374.2857360839844,"y":285.7142639160156,"wires":[[]]},{"id":"b57821be.97f958","type":"http in","z":"492da878.144","name":"","url":"/mysite","method":"get","upload":false,"swaggerDoc":"","x":290,"y":340,"wires":[["54227585.0640f4"]]},{"id":"adc22a6b.13934","type":"http in","z":"492da878.144","name":"","url":"/mysitepost","method":"post","upload":false,"swaggerDoc":"","x":310,"y":540,"wires":[["d94f1437.698d28","4019df5b.96da08"]]},{"id":"54227585.0640f4","type":"function","z":"492da878.144","name":"msg.url = \"mysitepost\";","func":"msg.url = \"mysitepost\";\nreturn msg;","outputs":1,"noerr":0,"x":530,"y":340,"wires":[["1f8dad10.7ee553"]]},{"id":"d94f1437.698d28","type":"debug","z":"492da878.144","name":"mysitepost","active":true,"console":"false","complete":"payload","x":950,"y":540,"wires":[]},{"id":"48581ac5.37f7ec","type":"http response","z":"492da878.144","name":"","x":970,"y":500,"wires":[]},{"id":"ca4df4ce.f65dc","type":"template","z":"492da878.144","name":"CSS","field":"payload.style","fieldType":"msg","format":"html","syntax":"mustache","template":"input[type=text], select {\n    width: 100%;\n    padding: 12px 20px;\n    margin: 8px 0;\n    display: inline-block;\n    border: 1px solid #ccc;\n    border-radius: 4px;\n    box-sizing: border-box;\n}\n\ninput[type=submit] {\n    width: 100%;\n    background-color: #4CAF50;\n    color: white;\n    padding: 14px 20px;\n    margin: 8px 0;\n    border: none;\n    border-radius: 4px;\n    cursor: pointer;\n}\n\ninput[type=submit]:hover {\n    background-color: #45a049;\n}\n\ndiv {\n    border-radius: 5px;\n    background-color: #f2f2f2;\n    padding: 20px;\n}","x":690,"y":440,"wires":[["33a5a09.ae970e"]]},{"id":"1f8dad10.7ee553","type":"template","z":"492da878.144","name":"JavaScript","field":"payload.script","fieldType":"msg","format":"javascript","syntax":"plain","template":"$(document).ready(function(e) {\n    \n    $(\"form[ajax=true]\").submit(function(e) {\n        \n        e.preventDefault();\n        \n        var form_data = $(this).serialize();\n        var form_url = $(this).attr(\"action\");\n        var form_method = $(this).attr(\"method\").toUpperCase();\n        \n        $(\"#loadingimg\").show();\n        \n        $.ajax({\n            url: form_url, \n            type: form_method,      \n            data: form_data,     \n            cache: false,\n            success: function(returnhtml){                          \n                $(\"#result\").html(returnhtml); \n                $(\"#loadingimg\").hide();                    \n            }           \n        });    \n        \n    });\n    \n});","x":530,"y":440,"wires":[["ca4df4ce.f65dc"]]},{"id":"aa436d8c.519548","type":"http response","z":"492da878.144","name":"","x":970,"y":440,"wires":[]},{"id":"33a5a09.ae970e","type":"template","z":"492da878.144","name":"HTML","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"<html>\n  <head>\n    <title>My Site</title>\n    <meta name=\"viewport\" content=\"initial-scale=1.0, user-scalable=no\">\n    <meta charset=\"utf-8\">\n    <script src=\"http://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.0/jquery.min.js\"></script>\n    <style>{{{payload.style}}}</style>\n  </head>\n  \n\n    <h2>Using CSS to style an HTML form with AJAX POST and Node-RED</h2>\n    <h4><a href=\"http://www.internetoflego.com\">Internet of LEGO</a></h4>\n\n<div>\n  <form method=\"post\" action=\"/{{url}}\" ajax=\"true\">\n    <label for=\"fname\">First Name</label>\n    <input type=\"text\" id=\"fname\" name=\"firstname\">\n\n    <label for=\"lname\">Last Name</label>\n    <input type=\"text\" id=\"lname\" name=\"lastname\">\n\n    <label for=\"country\">Country</label>\n    <select id=\"country\" name=\"country\">\n      <option value=\"uk\">United Kingdom</option>\n      <option value=\"canada\">Canada</option>\n      <option value=\"usa\">USA</option>\n    </select>\n  \n    <input type=\"submit\" value=\"Submit\">\n  </form>\n</div>\n<div>\n    <span id=\"result\"></span>\n</div>\n\n</body>\n</html>\n<script>{{{payload.script}}}</script>","x":830,"y":440,"wires":[["aa436d8c.519548"]]},{"id":"1d02e8c9.1cf6a7","type":"comment","z":"492da878.144","name":"Login Form","info":"","x":490,"y":400,"wires":[]},{"id":"bf46c91.39e6838","type":"function","z":"492da878.144","name":"return msg.payload to client","func":"msg.payload = 'The following data was submitted and available in the msg.payload: '+msg.payload;\nreturn msg;","outputs":1,"noerr":0,"x":700,"y":500,"wires":[["48581ac5.37f7ec"]]},{"id":"83894712.338bd8","type":"comment","z":"492da878.144","name":"Inject msg object properties","info":"","x":500,"y":300,"wires":[]},{"id":"4019df5b.96da08","type":"json","z":"492da878.144","name":"","pretty":false,"x":510,"y":500,"wires":[["bf46c91.39e6838"]]},{"id":"336c3298.329f8e","type":"comment","z":"492da878.144","name":"Website","info":"","x":270,"y":260,"wires":[]},{"id":"5f119ee2.8380b","type":"comment","z":"492da878.144","name":"Form Submission","info":"","x":300,"y":480,"wires":[]},{"id":"de7f2c26.7dad8","type":"comment","z":"492da878.144","name":"Node-RED Public Site - README","info":"This Flow demonstrates how to create\na simple frontend webpage with Node-RED.\n\nThe public facing page consists of the \nclient side JavaScript, CSS and HTML. \n\nThe important technique is how the mustache \ntemplates are used. Each template will set the\n\"property\" relative to the content. \n\nThe CSS node sets the \"msg.payload.style\" property.\nThe JavaScript node sets the \"msg.payload.script\" property.\nThe HTML node then includes these properties \n<script>{{{payload.script}}}</script>\n<style>{{{payload.style}}}</style>\n\n\nThis example was created by http://www.InternetofLEGO.com\n\n","x":600,"y":160,"wires":[]},{"id":"18872d4e.009d4b","type":"debug","z":"807487aa.61868","name":"PrintShopDict","active":true,"console":"false","complete":"payload","x":725.7142944335938,"y":357.1428527832031,"wires":[]},{"id":"47c10ef3.ed317","type":"inject","z":"807487aa.61868","name":"InitPrintShops","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"x":190,"y":360,"wires":[["5ede7e7b.316338"]]},{"id":"5ede7e7b.316338","type":"function","z":"807487aa.61868","name":"GetShops","func":"msg.payload = flow.get(\"shopDict\");\n\nreturn msg;","outputs":1,"noerr":0,"x":371.4286193847656,"y":360,"wires":[["18872d4e.009d4b"]]},{"id":"322e7b3f.924024","type":"comment","z":"807487aa.61868","name":"View Shops","info":"","x":537.142822265625,"y":360,"wires":[]},{"id":"40a1d790.f6acf8","type":"http in","z":"807487aa.61868","name":"MSGReceive","url":"/","method":"post","upload":false,"swaggerDoc":"","x":430,"y":680,"wires":[["902da93.2cae9d8"]]},{"id":"1b19cf15.4e4c91","type":"http response","z":"807487aa.61868","name":"MsgResponse","statusCode":"","headers":{},"x":2916.571563720703,"y":1140.7619018554688,"wires":[]},{"id":"cbabe595.d97f08","type":"debug","z":"807487aa.61868","name":"ReceivedMSG","active":false,"console":"false","complete":"true","x":220,"y":680,"wires":[]},{"id":"47606191.e53338","type":"debug","z":"807487aa.61868","name":"ViewResponse","active":true,"console":"false","complete":"payload","x":2060,"y":820,"wires":[]},{"id":"a5e99e62.e63148","type":"inject","z":"807487aa.61868","name":"TestCT1","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"x":180,"y":2220,"wires":[["b8524bf9.1c841"]]},{"id":"b8524bf9.1c841","type":"function","z":"807487aa.61868","name":"CreateCT1","func":"var mes = { CT1: {\n    emisor: 'cliente_test',\n    receptor: 'tienda_test',\n    time: {\n        timestamp: 1000,\n        creador: 'localhost'\n    },\n    listaP: {\n        producto: [\n            {\n                nombre: 'n1',\n                cantidad: 4\n            },\n            {\n                nombre: 'n2',\n                cantidad: 4\n            }\n        ]\n    },\n    listaT: {\n        tienda: [\n            {\n                idTienda: 'id1',\n                direccion: 'dir1',\n                tipo: 'php'\n            },\n            {\n                idTienda: 'id2',\n                direccion: 'dir2',\n                tipo: 'py'\n            }\n        ]\n    }\n}};\n\nmsg.payload = mes;\nreturn msg;","outputs":1,"noerr":0,"x":190,"y":2300,"wires":[["8d05a68b.37adb"]]},{"id":"8d05a68b.37adb","type":"xml","z":"807487aa.61868","name":"CT1ToXMLTest","attr":"","chr":"","x":380,"y":2300,"wires":[["640697f1.2e71f"]]},{"id":"640697f1.2e71f","type":"http request","z":"807487aa.61868","name":"SendCT1","method":"POST","ret":"txt","url":"localhost:1880","tls":"","x":560,"y":2300,"wires":[["2a34f04.aec141"]]},{"id":"2a34f04.aec141","type":"debug","z":"807487aa.61868","name":"Print Response","active":true,"console":"false","complete":"true","x":760,"y":2300,"wires":[]},{"id":"ed6c2dea.0efee8","type":"switch","z":"807487aa.61868","name":"SelectType","property":"type","propertyType":"msg","rules":[{"t":"eq","v":"CT4","vt":"str"},{"t":"eq","v":"CT6","vt":"str"},{"t":"eq","v":"MT3","vt":"str"},{"t":"eq","v":"MT5","vt":"str"}],"checkall":"true","outputs":4,"x":1530,"y":1020,"wires":[["ad5420d1.caddb"],["9ad7c557.1c4338"],["21822a70.1c10c6"],["2a76775b.3c4388"]]},{"id":"4c0767b0.b0c21","type":"function","z":"807487aa.61868","name":"CT1","func":"var shopDict = flow.get(\"shopDict\");\n\nvar idTienda = msg.payload.CT1.receptor;\nvar idCliente = msg.payload.CT1.emisor;\nvar listaP = msg.payload.CT1.listaP.producto;\nvar listaT = msg.payload.CT1.listaT.tienda;\nvar d = new Date();\n\nmsg.payload = undefined;\n\nif (shopDict[idTienda] !== undefined)\n{ // Si la tienda a la que envian el mensaje existe\n    if (shopDict[idTienda].isOpen) { // Si esta abierta\n        if (shopDict[idTienda].isInside(idCliente)) { // Si el cliente ya estaba dentro\n            msg.statusCode = 422;\n            msg.payload = \"The client is already inside the shop!\";\n        } else if (shopDict[idTienda].isFull()) { // Si esta llena\n            msg.payload = {\n                TC2: {\n                    emisor: idTienda,\n                    receptor: idCliente,\n                    time: {\n                        timestamp: d.getTime(),\n                        creador: flow.get(\"direccion\")\n                    }\n                }\n            };\n            msg.type = 2;\n        } else { // Si no esta llena\n            shopDict[idTienda].clientJoin(idCliente, listaT);\n            var listaCompra = shopDict[idTienda].sellItems(listaP);\n            \n            msg.payload = {\n                TC3: {\n                    emisor: idTienda,\n                    receptor: idCliente,\n                    time: {\n                        timestamp: d.getTime(),\n                        creador: flow.get(\"direccion\")\n                    },\n                    listaP: {producto: listaCompra}\n                }\n            };\n            msg.type = 3;\n        }\n    } else {\n        msg.statusCode = 403;\n        msg.payload = \"The shop is closed\";\n    }\n}\nelse {\n    msg.statusCode = 404;\n    msg.payload = \"Shop not found!\";\n}\n\nflow.set(\"shopDict\", shopDict);\n\nreturn msg;","outputs":1,"noerr":0,"x":1730,"y":1340,"wires":[["b215e760.701028"]]},{"id":"ad5420d1.caddb","type":"function","z":"807487aa.61868","name":"CT4","func":"var shopDict = flow.get(\"shopDict\");\n\nvar idTienda = msg.payload.CT4.receptor;\nvar idCliente = msg.payload.CT4.emisor;\nvar d = new Date();\n\nmsg.payload = undefined;\n\nif (shopDict[idTienda] !== undefined)\n{ // Si la tienda a la que envian el mensaje existe\n    if (shopDict[idTienda].isOpen) { // Si esta abierta\n        if (!shopDict[idTienda].isInside(idCliente)) { // Si el cliente ya estaba dentro\n            msg.statusCode = 422;\n            msg.payload = \"The client is NOT inside the shop!\";\n        } else {\n            var listaT = shopDict[idTienda].knownShops(idCliente);\n            \n            msg.payload = {\n                TC5: {\n                    emisor: idTienda,\n                    receptor: idCliente,\n                    time: {\n                        timestamp: d.getTime(),\n                        creador: flow.get(\"direccion\")\n                    },\n                    listaT: {tienda: listaT}\n                }\n            };\n        }\n    } else {\n        msg.statusCode = 403;\n        msg.payload = \"The shop is closed\";\n    }\n}\nelse {\n    msg.statusCode = 404;\n    msg.payload = \"Shop not found!\";\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":1730,"y":900,"wires":[["5281ddc6.1863b4"]]},{"id":"9ad7c557.1c4338","type":"function","z":"807487aa.61868","name":"CT6","func":"var shopDict = flow.get(\"shopDict\");\n\nvar idTienda = msg.payload.CT6.receptor;\nvar idCliente = msg.payload.CT6.emisor;\nvar d = new Date();\n\nmsg.payload = undefined;\n\nif (shopDict[idTienda] !== undefined)\n{ // Si la tienda a la que envian el mensaje existe\n    if (shopDict[idTienda].isOpen) { // Si esta abierta\n        if (!shopDict[idTienda].isInside(idCliente)) {\n            msg.statusCode = 422;\n            msg.payload = \"The client is NOT inside the shop!\";\n        } else {\n            shopDict[idTienda].clientLeave(idCliente);\n            flow.set(\"shopDict\", shopDict);\n            \n            msg.payload = {\n                TC7: {\n                    emisor: idTienda,\n                    receptor: idCliente,\n                    time: {\n                        timestamp: d.getTime(),\n                        creador: flow.get(\"direccion\")\n                    }\n                }\n            };\n        }\n    } else {\n        msg.statusCode = 403;\n        msg.payload = \"The shop is closed\";\n    }\n}\nelse {\n    msg.statusCode = 404;\n    msg.payload = \"Shop not found!\";\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":1730,"y":980,"wires":[["22561c2a.344844"]]},{"id":"692716aa.20a4e8","type":"function","z":"807487aa.61868","name":"MT1","func":"var Shop = flow.get(\"Shop\");\nvar shopDict = flow.get(\"shopDict\");\nflow.set(\"monitor\", msg.payload.MT1.time.creador);\n\nfunction randRange(min, max)\n{\n    return Math.floor(Math.random() * (max - min + 1) + min);\n}\n\nvar idTienda = msg.payload.MT1.receptor;\n\nif (shopDict[idTienda] === undefined) {\n    var forum = randRange(3, 5);\n    var listaP = msg.payload.MT1.listaP.producto;\n    var d = new Date();\n    \n    shopDict[idTienda] = new Shop(forum, listaP);\n    flow.set(\"shopDict\", shopDict);\n    \n    msg.payload = {\n        TM2: {\n            emisor: idTienda,\n            receptor: msg.payload.MT1.emisor,\n            time: {\n                timestamp: d.getTime(),\n                creador: flow.get(\"direccion\")\n            }\n        }\n    };\n}\nelse {\n    msg.statusCode = 422;\n    msg.payload = \"The shop already exists\";\n}\n\n\nreturn msg;","outputs":1,"noerr":0,"x":1730,"y":1220,"wires":[["6d1d51fe.ab4788"]]},{"id":"21822a70.1c10c6","type":"function","z":"807487aa.61868","name":"MT3","func":"var shopDict = flow.get(\"shopDict\");\n\nvar idTienda = msg.payload.MT3.receptor;\nvar d = new Date();\n\nmsg.payload = undefined;\n\nif (shopDict[idTienda] !== undefined)\n{ // Si la tienda a la que envian el mensaje existe\n    if (shopDict[idTienda].isOpen) { // Si esta abierta\n        msg.payload = {\n            TM4: {\n                emisor: idTienda,\n                receptor: idCliente,\n                time: {\n                    timestamp: d.getTime(),\n                    creador: flow.get(\"direccion\")\n                },\n                listaP: {producto: shopDict[idtienda].products}\n            }\n        };\n    } else {\n        msg.statusCode = 403;\n        msg.payload = \"The shop is closed\";\n    }\n}\nelse {\n    msg.statusCode = 404;\n    msg.payload = \"Shop not found!\";\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":1730,"y":1060,"wires":[["90688579.10e32"]]},{"id":"2a76775b.3c4388","type":"function","z":"807487aa.61868","name":"MT5","func":"var shopDict = flow.get(\"shopDict\");\n\nvar idTienda = msg.payload.MT5.receptor;\nvar d = new Date();\n\nmsg.payload = undefined;\n\nif (shopDict[idTienda] !== undefined)\n{ // Si la tienda a la que envian el mensaje existe\n    if (shopDict[idTienda].isOpen) { // Si esta abierta\n        shopDict[idTienda].isOpen = false;\n    } else {\n        msg.statusCode = 422;\n        msg.payload = \"The shop is already closed\";\n    }\n}\nelse {\n    msg.statusCode = 404;\n    msg.payload = \"Shop not found!\";\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":1730,"y":1140,"wires":[["7d0667a0.2fb888"]]},{"id":"7e80b04e.2aa9d8","type":"function","z":"85ae90a6.827ac8","name":"msg.url = \"create\";","func":"msg.url = \"create\";\nreturn msg;","outputs":1,"noerr":0,"x":370,"y":80,"wires":[["c43da950.f760f8"]]},{"id":"487a2606.1ccc9","type":"http in","z":"85ae90a6.827ac8","name":"","url":"/create","method":"get","upload":false,"swaggerDoc":"","x":130,"y":80,"wires":[["7e80b04e.2aa9d8"]]},{"id":"1012afc8.cd9ac8","type":"comment","z":"85ae90a6.827ac8","name":"Agent Creation Form","info":"","x":370,"y":140,"wires":[]},{"id":"c43da950.f760f8","type":"template","z":"85ae90a6.827ac8","name":"JavaScript","field":"payload.script","fieldType":"msg","format":"javascript","syntax":"plain","template":"$(document).ready(function(e) {\n    \n    $(\"form[ajax=true]\").submit(function(e) {\n        \n        e.preventDefault();\n        \n        var form_data = $(this).serialize();\n        var form_url = $(this).attr(\"action\");\n        var form_method = $(this).attr(\"method\").toUpperCase();\n        \n        $(\"#loadingimg\").show();\n        \n        $.ajax({\n            url: form_url, \n            type: form_method,      \n            data: form_data,     \n            cache: false,\n            success: function(returnhtml){                          \n                $(\"#result\").html(returnhtml); \n                $(\"#loadingimg\").hide();                    \n            }           \n        });    \n        \n    });\n    \n});","output":"str","x":380,"y":180,"wires":[["d8742f0e.845a88"]]},{"id":"d8742f0e.845a88","type":"template","z":"85ae90a6.827ac8","name":"CSS","field":"payload.style","fieldType":"msg","format":"html","syntax":"mustache","template":"input[type=text], select {\n    width: 100%;\n    padding: 12px 20px;\n    margin: 8px 0;\n    display: inline-block;\n    border: 1px solid #ccc;\n    border-radius: 4px;\n    box-sizing: border-box;\n}\n\n.formulario{\n    width: 40%;\n}\n\nh1{\n    font-family:Monospace;\n    color:red;\n}\n\ninput[type=submit] {\n    width: 100%;\n    background-color: #4CAF50;\n    color: white;\n    padding: 14px 20px;\n    margin: 8px 0;\n    border: none;\n    border-radius: 4px;\n    cursor: pointer;\n}\n\ninput[type=submit]:hover {\n    background-color: #45a049;\n}\n\ndiv {\n    border-radius: 5px;\n    background-color: #f2f2f2;\n    padding: 20px;\n    text-align:center;\n    top:0;\n    bottom: 0;\n    left: 0;\n    right: 0;\n    margin: auto;\n}","output":"str","x":540,"y":180,"wires":[["dad94973.4e277"]]},{"id":"dad94973.4e277","type":"template","z":"85ae90a6.827ac8","name":"HTML","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"<html>\n  <head>\n    <title>Agent Creation</title>\n    <meta name=\"viewport\" content=\"initial-scale=1.0, user-scalable=no\">\n    <meta charset=\"utf-8\">\n    <script src=\"http://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.0/jquery.min.js\"></script>\n    <style>{{{payload.style}}}</style>\n  </head>\n<body>\n    <h1 style=\"text-align:center\">Create your agent.</h1>\n    \n<div class=\"formulario\">\n  <form method=\"post\" action=\"/{{url}}\" ajax=\"true\">\n    <label for=\"name\">Name</label>\n    <input type=\"text\" id=\"name\" name=\"name\">\n  \n    <input type=\"submit\" value=\"Submit\">\n  </form>\n</div>\n<div class=\"formulario\">\n    <span id=\"result\"></span>\n</div>\n\n</body>\n</html>\n<script>{{{payload.script}}}</script>","output":"str","x":680,"y":180,"wires":[["ab0edc27.643d48"]]},{"id":"ab0edc27.643d48","type":"http response","z":"85ae90a6.827ac8","name":"","statusCode":"","headers":{},"x":820,"y":180,"wires":[]},{"id":"65dc0cb.39ddbf4","type":"http in","z":"85ae90a6.827ac8","name":"","url":"/create","method":"post","upload":false,"swaggerDoc":"","x":110,"y":260,"wires":[["93f0e5af.71ba58"]]},{"id":"36890cb8.de657c","type":"function","z":"85ae90a6.827ac8","name":"return msg.payload to client","func":"msg.payload = 'The following agent was submitted: '+msg.payload;\nreturn msg;","outputs":1,"noerr":0,"x":560,"y":300,"wires":[["b824df5a.8d5bc8"]]},{"id":"b824df5a.8d5bc8","type":"http response","z":"85ae90a6.827ac8","name":"","x":790,"y":320,"wires":[]},{"id":"93f0e5af.71ba58","type":"function","z":"85ae90a6.827ac8","name":"Create Agent","func":"addAgent = flow.get(\"addAgent\");\n\naddAgent(msg.payload.name)\n\nmsg.payload = \"Done!\"\nreturn msg;","outputs":1,"noerr":0,"x":310,"y":280,"wires":[["36890cb8.de657c"]]},{"id":"ab406d6d.6ef82","type":"http in","z":"85ae90a6.827ac8","name":"","url":"/migrate","method":"get","upload":false,"swaggerDoc":"","x":110,"y":400,"wires":[["5681675e.94c94"]]},{"id":"c9795888.082178","type":"http response","z":"85ae90a6.827ac8","name":"","x":970,"y":780,"wires":[]},{"id":"fb47fe95.d0db","type":"template","z":"85ae90a6.827ac8","name":"CSS","field":"payload.style","fieldType":"msg","format":"html","syntax":"mustache","template":"input[type=text], select {\n    width: 100%;\n    padding: 12px 20px;\n    margin: 8px 0;\n    display: inline-block;\n    border: 1px solid #ccc;\n    border-radius: 4px;\n    box-sizing: border-box;\n}\n\ninput[type=submit] {\n    width: 100%;\n    background-color: #4CAF50;\n    color: white;\n    padding: 14px 20px;\n    margin: 8px 0;\n    border: none;\n    border-radius: 4px;\n    cursor: pointer;\n}\n\nh1{\n    font-family:Monospace;\n    color:red;\n}\n\ninput[type=submit]:hover {\n    background-color: #45a049;\n}\n\n.formulario{\n    width: 40%;\n}\n\ndiv {\n    border-radius: 5px;\n    background-color: #f2f2f2;\n    padding: 20px;\n    text-align:center;\n    top:0;\n    bottom: 0;\n    left: 0;\n    right: 0;\n    margin: auto;\n}","output":"str","x":530,"y":500,"wires":[["b0e20d99.64a6e"]]},{"id":"feb4c0cb.52ac9","type":"template","z":"85ae90a6.827ac8","name":"JavaScript","field":"payload.script","fieldType":"msg","format":"javascript","syntax":"plain","template":"$(document).ready(function(e) {\n    $(\"form[ajax=true]\").submit(function(e) {\n        \n        e.preventDefault();\n        \n        var form_data = $(this).serialize();\n        var form_url = $(this).attr(\"action\");\n        var form_method = $(this).attr(\"method\").toUpperCase();\n        \n        $(\"#loadingimg\").show();\n        \n        $.ajax({\n            url: form_url, \n            type: form_method,      \n            data: form_data,     \n            cache: false,\n            success: function(returnhtml){                          \n                $(\"#result\").html(returnhtml); \n                $(\"#loadingimg\").hide();                    \n            }           \n        });    \n        \n    });\n    \n    //var agentDict = JSON.parse(ajson)\n    var drAgent = document.getElementById('agent');\n    for (var key in agentDict)\n    {\n        if (agentDict.hasOwnProperty(key)) {           \n            var opt = document.createElement('option');\n            opt.innerHtml = key;\n            opt.textContent = agentDict[key].id + ': ' + agentDict[key].name;\n            opt.value = key;\n            drAgent.appendChild(opt);\n        }\n    }\n});","output":"str","x":350,"y":500,"wires":[["fb47fe95.d0db"]]},{"id":"90c26deb.0e9ef","type":"http response","z":"85ae90a6.827ac8","name":"","x":1010,"y":500,"wires":[]},{"id":"102cd82d.47e9a","type":"template","z":"85ae90a6.827ac8","name":"HTML","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"<html>\n  <head>\n    <title>Migration</title>\n    <meta name=\"viewport\" content=\"initial-scale=1.0, user-scalable=no\">\n    <meta charset=\"utf-8\">\n    <script src=\"http://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.0/jquery.min.js\"></script>\n    <style>{{{payload.style}}}</style>\n  </head>\n  \n\n    <h1 style=\"text-align:center\">Now it's time to send your agent to another location.</h1>\n\n<div class=\"formulario\">\n  <form method=\"post\" action=\"/{{url}}\" ajax=\"true\">\n    <label for=\"dest\">Destination</label>\n    <input type=\"text\" id=\"dest\" name=\"destination\">\n\n    <!--<label for=\"id\">Agent Identifier</label>\n    <input type=\"text\" id=\"id\" name=\"id\">-->\n\n    <label for=\"agent\">Agent</label>\n    <select id=\"agent\" name=\"agent\"></select>\n  \n    <input type=\"submit\" value=\"Submit\">\n  </form>\n</div>\n<div class=\"formulario\">\n    <span id=\"result\"></span>\n</div>\n\n</body>\n</html>\n<script type=\"text/javascript\">\n    var agentDict = {{{payload.agdict}}};\n    {{{payload.script}}}\n</script>","output":"str","x":850,"y":500,"wires":[["90c26deb.0e9ef"]]},{"id":"8db8dbe0.c0e47","type":"comment","z":"85ae90a6.827ac8","name":"Migrate Form","info":"","x":310,"y":460,"wires":[]},{"id":"5681675e.94c94","type":"function","z":"85ae90a6.827ac8","name":"msg.url = \"migrate\";","func":"msg.url = \"migrate\";\nreturn msg;","outputs":1,"noerr":0,"x":340,"y":400,"wires":[["feb4c0cb.52ac9"]]},{"id":"b943725c.6c50f","type":"http in","z":"85ae90a6.827ac8","name":"","url":"/migrate","method":"post","upload":false,"swaggerDoc":"","x":150,"y":660,"wires":[["382b4587.392b12"]]},{"id":"382b4587.392b12","type":"function","z":"85ae90a6.827ac8","name":"Search Agent","func":"var dirTable = flow.get(\"dirTable\");\nvar hostname = flow.get(\"hostname\");\nvar port = flow.get(\"port\");\nif (!dirTable.hasOwnProperty(msg.payload.agent)\n|| dirTable[msg.payload.agent][\"hostname\"] !== hostname\n|| dirTable[msg.payload.agent][\"port\"] !== port)\n{\n    msg.payload = \"The Agent is not in this host!\";\n    return msg;\n}\n\nvar agentDict = flow.get(\"agentDict\");\n\nvar ag = agentDict[msg.payload.agent];\n\nflow.set(\"removeId\", msg.payload.agent)\n\nmsg.url = msg.payload[\"destination\"].concat('/receive')\nmsg.headers = {};\nmsg.headers['content-type'] = 'application/xml';\nmsg.payload = ag\nreturn msg;","outputs":1,"noerr":0,"x":340,"y":660,"wires":[["54ac98dd.de9728"]]},{"id":"d4c57529.61db78","type":"function","z":"85ae90a6.827ac8","name":"return msg.payload to client","func":"msg.payload = 'The following agent was submitted: '+msg.payload;\nreturn msg;","outputs":1,"noerr":0,"x":820,"y":660,"wires":[["c9795888.082178"]]},{"id":"4f37bcaa.8ec40c","type":"http request","z":"85ae90a6.827ac8","name":"","method":"POST","ret":"txt","url":"","tls":"","x":490,"y":780,"wires":[["918533c2.9e3bd8"]]},{"id":"5485627.b5c501c","type":"xml","z":"85ae90a6.827ac8","name":"","attr":"","chr":"","x":310,"y":780,"wires":[["4f37bcaa.8ec40c"]]},{"id":"918533c2.9e3bd8","type":"function","z":"85ae90a6.827ac8","name":"Delete Agent","func":"var remAgent = flow.get(\"remAgent\");\nvar id = flow.get(\"removeId\");\nvar dirTable = flow.get(\"dirTable\");\n\nremAgent(id);\nvar hp = msg.url.split(\"/\")[0].split(\":\")\ndirTable[id] = {\"hostname\": hp[0], \"port\": hp[1]}\n\nflow.set(\"removeId\", undefined);\nflow.set(\"dirTable\", dirTable);\n\nmsg.payload = \"Done!\"\nreturn msg;","outputs":1,"noerr":0,"x":650,"y":780,"wires":[["d4c57529.61db78"]]},{"id":"8fdaf49f.9dd528","type":"http in","z":"85ae90a6.827ac8","name":"","url":"/receive","method":"post","upload":false,"swaggerDoc":"","x":150,"y":900,"wires":[["fd3176b6.43d6e8"]]},{"id":"1d2a7908.75898f","type":"function","z":"85ae90a6.827ac8","name":"Build Agent","func":"var Agent = flow.get(\"Agent\");\nvar ag;\nvar aux;\n\nfor (var key in msg.payload)\n{\n    if (msg.payload.hasOwnProperty(key)) {           \n        aux = msg.payload[key];\n        ag = new Agent(aux['id'][0], aux['name'][0])\n    }\n    \n}\n\nmsg.payload = ag\nreturn msg;","outputs":1,"noerr":0,"x":510,"y":900,"wires":[["552767b0.9f8f3"]]},{"id":"fd3176b6.43d6e8","type":"xml","z":"85ae90a6.827ac8","name":"","attr":"","chr":"","x":330,"y":900,"wires":[["1d2a7908.75898f"]]},{"id":"552767b0.9f8f3","type":"function","z":"85ae90a6.827ac8","name":"Add Agent","func":"//var addAgent = flow.get(\"addAgent\");\nvar agentDict = flow.get(\"agentDict\");\nvar dirTable = flow.get(\"dirTable\");\nvar hostname = flow.get(\"hostname\");\nvar port = flow.get(\"port\");\n\nagentDict[msg.payload.id] = msg.payload;\ndirTable[msg.payload.id] = {\"hostname\": hostname, \"port\": port}\n//addAgent(msg.payload)\n\nflow.set(\"agentDict\", agentDict);\n\nreturn msg;","outputs":1,"noerr":0,"x":670,"y":960,"wires":[["3405ee0e.d070b2","76f6d934.7e8f2"]]},{"id":"3405ee0e.d070b2","type":"http response","z":"85ae90a6.827ac8","name":"","x":890,"y":1060,"wires":[]},{"id":"76f6d934.7e8f2","type":"json","z":"85ae90a6.827ac8","name":"","pretty":false,"x":835,"y":903.3333333333333,"wires":[["4101afba.9457a"]]},{"id":"4101afba.9457a","type":"debug","z":"85ae90a6.827ac8","name":"","active":false,"console":"false","complete":"false","x":983.8888888888887,"y":903.3333333333333,"wires":[]},{"id":"b0e20d99.64a6e","type":"function","z":"85ae90a6.827ac8","name":"","func":"var agentDict = flow.get('agentDict');\n\nmsg.payload.agdict = JSON.stringify(agentDict)\n\nreturn msg;","outputs":1,"noerr":0,"x":690,"y":500,"wires":[["102cd82d.47e9a"]]},{"id":"54ac98dd.de9728","type":"switch","z":"85ae90a6.827ac8","name":"","property":"payload","propertyType":"msg","rules":[{"t":"cont","v":"The Agent is not in this host!","vt":"str"},{"t":"else"}],"checkall":"true","outputs":2,"x":531,"y":619,"wires":[["d4c57529.61db78"],["5485627.b5c501c"]]},{"id":"70fc7d39.ed1ce4","type":"http in","z":"85ae90a6.827ac8","name":"","url":"/send","method":"get","upload":false,"swaggerDoc":"","x":140,"y":1120,"wires":[["43075cfe.28df7c"]]},{"id":"9fbadee.867caa","type":"template","z":"85ae90a6.827ac8","name":"CSS","field":"payload.style","fieldType":"msg","format":"html","syntax":"mustache","template":"input[type=text], select {\n    width: 100%;\n    padding: 12px 20px;\n    margin: 8px 0;\n    display: inline-block;\n    border: 1px solid #ccc;\n    border-radius: 4px;\n    box-sizing: border-box;\n}\n\ninput[type=submit] {\n    width: 100%;\n    background-color: #4CAF50;\n    color: white;\n    padding: 14px 20px;\n    margin: 8px 0;\n    border: none;\n    border-radius: 4px;\n    cursor: pointer;\n}\n\nh1{\n    font-family:Monospace;\n    color:red;\n}\n\ninput[type=submit]:hover {\n    background-color: #45a049;\n}\n\n.formulario{\n    width: 40%;\n}\n\ndiv {\n    border-radius: 5px;\n    background-color: #f2f2f2;\n    padding: 20px;\n    text-align:center;\n    top:0;\n    bottom: 0;\n    left: 0;\n    right: 0;\n    margin: auto;\n}","output":"str","x":570,"y":1220,"wires":[["59b7b6fe.88ad1"]]},{"id":"fbc185d8.f3b208","type":"template","z":"85ae90a6.827ac8","name":"JavaScript","field":"payload.script","fieldType":"msg","format":"javascript","syntax":"plain","template":"$(document).ready(function(e) {\n    $(\"form[ajax=true]\").submit(function(e) {\n        \n        e.preventDefault();\n        \n        var form_data = $(this).serialize();\n        var form_url = $(this).attr(\"action\");\n        var form_method = $(this).attr(\"method\").toUpperCase();\n        \n        $(\"#loadingimg\").show();\n        \n        $.ajax({\n            url: form_url, \n            type: form_method,      \n            data: form_data,     \n            cache: false,\n            success: function(returnhtml){                          \n                $(\"#result\").html(returnhtml); \n                $(\"#loadingimg\").hide();                    \n            }           \n        });    \n        \n    });\n    \n    //var agentDict = JSON.parse(ajson)\n    var drAgent = document.getElementById('agent');\n    for (var key in agentDict)\n    {\n        if (agentDict.hasOwnProperty(key)) {           \n            var opt = document.createElement('option');\n            opt.innerHtml = key;\n            opt.textContent = agentDict[key].id + ': ' + agentDict[key].name;\n            opt.value = key;\n            drAgent.appendChild(opt);\n        }\n    }\n    \n    var drDest = document.getElementById('dest');\n    for (var key in dirTable)\n    {\n        if (dirTable.hasOwnProperty(key)) {           \n            opt = document.createElement('option');\n            opt.innerHtml = key;\n            opt.textContent = key;\n            opt.value = key;\n            drDest.appendChild(opt);\n        }\n    }\n});","output":"str","x":390,"y":1220,"wires":[["9fbadee.867caa"]]},{"id":"f8f55104.fba38","type":"http response","z":"85ae90a6.827ac8","name":"","x":1050,"y":1220,"wires":[]},{"id":"1f45ae7c.dff902","type":"template","z":"85ae90a6.827ac8","name":"HTML","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"<html>\n  <head>\n    <title>Send Message</title>\n    <meta name=\"viewport\" content=\"initial-scale=1.0, user-scalable=no\">\n    <meta charset=\"utf-8\">\n    <script src=\"http://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.0/jquery.min.js\"></script>\n    <style>{{{payload.style}}}</style>\n  </head>\n  \n\n    <h1 style=\"text-align:center\">Now it's time to send messages between agents!</h1>\n\n<div class=\"formulario\">\n  <form method=\"post\" action=\"/{{url}}\" ajax=\"true\">\n    <label for=\"agent\">SenderId</label>\n    <select id=\"agent\" name=\"agent\"></select>\n    \n    <label for=\"dest\">DestId</label>\n    <select id=\"dest\" name=\"destination\"></select>\n    \n    <label for=\"mess\">Message</label>\n    <input type=\"text\" id=\"mess\" name=\"message\">\n  \n    <input type=\"submit\" value=\"Submit\">\n  </form>\n</div>\n<div class=\"formulario\">\n    <span id=\"result\"></span>\n</div>\n\n</body>\n</html>\n<script type=\"text/javascript\">\n    var agentDict = {{{payload.agdict}}};\n    var dirTable = {{{payload.dirtab}}};\n    {{{payload.script}}}\n</script>","output":"str","x":890,"y":1220,"wires":[["f8f55104.fba38"]]},{"id":"a2d72575.89f8c","type":"comment","z":"85ae90a6.827ac8","name":"Migrate Form","info":"","x":350,"y":1180,"wires":[]},{"id":"43075cfe.28df7c","type":"function","z":"85ae90a6.827ac8","name":"msg.url = \"send\";","func":"msg.url = \"send\";\nreturn msg;","outputs":1,"noerr":0,"x":380,"y":1120,"wires":[["fbc185d8.f3b208"]]},{"id":"59b7b6fe.88ad1","type":"function","z":"85ae90a6.827ac8","name":"","func":"var agentDict = flow.get('agentDict');\nvar dirTable = flow.get('dirTable');\n\nmsg.payload.agdict = JSON.stringify(agentDict)\nmsg.payload.dirtab = JSON.stringify(dirTable)\n\nreturn msg;","outputs":1,"noerr":0,"x":730,"y":1220,"wires":[["1f45ae7c.dff902"]]},{"id":"6ee64c3a.850e6c","type":"http response","z":"85ae90a6.827ac8","name":"","x":1070,"y":1360,"wires":[]},{"id":"fe5d703d.e363f8","type":"http in","z":"85ae90a6.827ac8","name":"","url":"/send","method":"post","upload":false,"swaggerDoc":"","x":150,"y":1380,"wires":[["72f2e058.c75a38"]]},{"id":"72f2e058.c75a38","type":"function","z":"85ae90a6.827ac8","name":"Search Agent","func":"var dirTable = flow.get(\"dirTable\");\nvar hostname = flow.get(\"hostname\");\nvar port = flow.get(\"port\");\nif (!dirTable.hasOwnProperty(msg.payload.agent)\n|| dirTable[msg.payload.agent][\"hostname\"] !== hostname\n|| dirTable[msg.payload.agent][\"port\"] !== port)\n{\n    msg.payload = \"The Agent is not in this host!\";\n    return msg;\n}\n\nvar agentDict = flow.get(\"agentDict\");\n\nvar ag = agentDict[msg.payload.agent];\nvar result = ag.sendMessage(msg.payload.message, msg.payload.destination);\n\nmsg.payload = result;\nreturn msg;","outputs":1,"noerr":0,"x":340,"y":1380,"wires":[["1651b83d.0a2c08"]]},{"id":"51a99d80.9bf76c","type":"function","z":"85ae90a6.827ac8","name":"Success","func":"msg.payload = 'Noice! <br> <br> <img src=\"https://media.tenor.com/images/b67da9f2ab503e38e07167d48ba0905f/tenor.gif\"></img>';\nreturn msg;","outputs":1,"noerr":0,"x":940,"y":1420,"wires":[["6ee64c3a.850e6c"]]},{"id":"a9b0a0bc.1140c","type":"http in","z":"85ae90a6.827ac8","name":"","url":"/rmess","method":"post","upload":false,"swaggerDoc":"","x":150,"y":1620,"wires":[["ab74516a.2ba49"]]},{"id":"1651b83d.0a2c08","type":"switch","z":"85ae90a6.827ac8","name":"","property":"payload","propertyType":"msg","rules":[{"t":"cont","v":"The Agent is not in this host!","vt":"str"},{"t":"false"},{"t":"true"},{"t":"else"}],"checkall":"true","outputs":4,"x":410,"y":1480,"wires":[["d2ff1e82.5ea45"],["d2ff1e82.5ea45"],["51a99d80.9bf76c"],["9a1aada.73a95d"]]},{"id":"9a1aada.73a95d","type":"function","z":"85ae90a6.827ac8","name":"Send Message","func":"msg.url = msg.payload[0]['hostname'].concat(':').concat(msg.payload[0]['port']).concat('/rmess')\nmsg.payload = msg.payload[1]\nreturn msg;","outputs":1,"noerr":0,"x":560,"y":1520,"wires":[["2daa6d43.7453da"]]},{"id":"d2ff1e82.5ea45","type":"function","z":"85ae90a6.827ac8","name":"Failure (Local)","func":"msg.payload = 'ERROR!';\nreturn msg;","outputs":1,"noerr":0,"x":760,"y":1360,"wires":[["6ee64c3a.850e6c"]]},{"id":"c3213d20.b09098","type":"http request","z":"85ae90a6.827ac8","name":"","method":"POST","ret":"txt","url":"","tls":"","x":910,"y":1520,"wires":[["51a99d80.9bf76c"]]},{"id":"2daa6d43.7453da","type":"xml","z":"85ae90a6.827ac8","name":"","attr":"","chr":"","x":750,"y":1520,"wires":[["c3213d20.b09098"]]},{"id":"7ae784bd.dd2654","type":"function","z":"85ae90a6.827ac8","name":"Search Agent","func":"var dirTable = flow.get(\"dirTable\");\nvar hostname = flow.get(\"hostname\");\nvar port = flow.get(\"port\");\n\nvar aux = msg.payload['root'];\nif (!dirTable.hasOwnProperty(aux.destId)\n|| dirTable[aux.destId][\"hostname\"] !== hostname\n|| dirTable[aux.destId][\"port\"] !== port)\n{\n    msg.payload = aux;\n    return msg;\n}\n\nvar agentDict = flow.get(\"agentDict\");\n\nvar ag = agentDict[aux.destId];\nag.receiveMessage(aux.message[0], aux.senderId[0], aux.timestamp[0]);\n\nmsg.payload = \"Noice\";\nreturn msg;","outputs":1,"noerr":0,"x":520,"y":1620,"wires":[["cc8ef119.a66168"]]},{"id":"ab74516a.2ba49","type":"xml","z":"85ae90a6.827ac8","name":"","attr":"","chr":"","x":330,"y":1620,"wires":[["7ae784bd.dd2654"]]},{"id":"cc8ef119.a66168","type":"http response","z":"85ae90a6.827ac8","name":"","statusCode":"","headers":{},"x":710,"y":1620,"wires":[]},{"id":"e5ee3fe2.f7aef","type":"http in","z":"85ae90a6.827ac8","name":"","url":"/delete","method":"get","upload":false,"swaggerDoc":"","x":130,"y":1720,"wires":[["f583831.c8178"]]},{"id":"85e420d5.15acd8","type":"template","z":"85ae90a6.827ac8","name":"CSS","field":"payload.style","fieldType":"msg","format":"html","syntax":"mustache","template":"input[type=text], select {\n    width: 100%;\n    padding: 12px 20px;\n    margin: 8px 0;\n    display: inline-block;\n    border: 1px solid #ccc;\n    border-radius: 4px;\n    box-sizing: border-box;\n}\n\ninput[type=submit] {\n    width: 100%;\n    background-color: #4CAF50;\n    color: white;\n    padding: 14px 20px;\n    margin: 8px 0;\n    border: none;\n    border-radius: 4px;\n    cursor: pointer;\n}\n\nh1{\n    font-family:Monospace;\n    color:red;\n}\n\ninput[type=submit]:hover {\n    background-color: #45a049;\n}\n\n.formulario{\n    width: 40%;\n}\n\ndiv {\n    border-radius: 5px;\n    background-color: #f2f2f2;\n    padding: 20px;\n    text-align:center;\n    top:0;\n    bottom: 0;\n    left: 0;\n    right: 0;\n    margin: auto;\n}","output":"str","x":550,"y":1820,"wires":[["3d7ebdae.d141ca"]]},{"id":"b182af92.bb39b8","type":"template","z":"85ae90a6.827ac8","name":"JavaScript","field":"payload.script","fieldType":"msg","format":"javascript","syntax":"plain","template":"$(document).ready(function(e) {\n    $(\"form[ajax=true]\").submit(function(e) {\n        \n        e.preventDefault();\n        \n        var form_data = $(this).serialize();\n        var form_url = $(this).attr(\"action\");\n        var form_method = $(this).attr(\"method\").toUpperCase();\n        \n        $(\"#loadingimg\").show();\n        \n        $.ajax({\n            url: form_url, \n            type: form_method,      \n            data: form_data,     \n            cache: false,\n            success: function(returnhtml){                          \n                $(\"#result\").html(returnhtml); \n                $(\"#loadingimg\").hide();                    \n            }           \n        });    \n        \n    });\n    \n    //var agentDict = JSON.parse(ajson)\n    var drAgent = document.getElementById('agent');\n    for (var key in agentDict)\n    {\n        if (agentDict.hasOwnProperty(key)) {           \n            var opt = document.createElement('option');\n            opt.innerHtml = key;\n            opt.textContent = agentDict[key].id + ': ' + agentDict[key].name;\n            opt.value = key;\n            drAgent.appendChild(opt);\n        }\n    }\n});","output":"str","x":370,"y":1820,"wires":[["85e420d5.15acd8"]]},{"id":"e2b8f8a0.b70208","type":"http response","z":"85ae90a6.827ac8","name":"","statusCode":"","headers":{},"x":1030,"y":1820,"wires":[]},{"id":"e45cdb82.c904d","type":"template","z":"85ae90a6.827ac8","name":"HTML","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"<html>\n  <head>\n    <title>Delete agent</title>\n    <meta name=\"viewport\" content=\"initial-scale=1.0, user-scalable=no\">\n    <meta charset=\"utf-8\">\n    <script src=\"http://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.0/jquery.min.js\"></script>\n    <style>{{{payload.style}}}</style>\n  </head>\n  \n\n    <h1 style=\"text-align:center\">Now it's time to kill an agent!</h1>\n\n<div class=\"formulario\">\n  <form method=\"post\" action=\"/{{url}}\" ajax=\"true\">\n    \n    <label for=\"agent\">Agent</label>\n    <select id=\"agent\" name=\"agent\"></select>\n  \n    <input type=\"submit\" value=\"Submit\">\n  </form>\n</div>\n<div class=\"formulario\">\n    <span id=\"result\"></span>\n</div>\n\n</body>\n</html>\n<script type=\"text/javascript\">\n    var agentDict = {{{payload.agdict}}};\n    {{{payload.script}}}\n</script>","output":"str","x":870,"y":1820,"wires":[["e2b8f8a0.b70208"]]},{"id":"333558b8.f533","type":"comment","z":"85ae90a6.827ac8","name":"Migrate Form","info":"","x":330,"y":1780,"wires":[]},{"id":"f583831.c8178","type":"function","z":"85ae90a6.827ac8","name":"msg.url = \"delete\";","func":"msg.url = \"delete\";\nreturn msg;","outputs":1,"noerr":0,"x":350,"y":1720,"wires":[["b182af92.bb39b8"]]},{"id":"3d7ebdae.d141ca","type":"function","z":"85ae90a6.827ac8","name":"","func":"var agentDict = flow.get('agentDict');\n\nmsg.payload.agdict = JSON.stringify(agentDict)\n\nreturn msg;","outputs":1,"noerr":0,"x":710,"y":1820,"wires":[["e45cdb82.c904d"]]},{"id":"14bceba0.e9aca4","type":"http response","z":"85ae90a6.827ac8","name":"","x":530,"y":1960,"wires":[]},{"id":"ef81ddbe.5fb0e8","type":"http in","z":"85ae90a6.827ac8","name":"","url":"/delete","method":"post","upload":false,"swaggerDoc":"","x":140,"y":1960,"wires":[["2af72139.21a3a6"]]},{"id":"2af72139.21a3a6","type":"function","z":"85ae90a6.827ac8","name":"Search Agent","func":"var dirTable = flow.get(\"dirTable\");\nvar hostname = flow.get(\"hostname\");\nvar port = flow.get(\"port\");\nif (!dirTable.hasOwnProperty(msg.payload.agent)\n|| dirTable[msg.payload.agent][\"hostname\"] !== hostname\n|| dirTable[msg.payload.agent][\"port\"] !== port)\n{\n    msg.payload = \"The Agent is not in this host!\";\n    return msg;\n}\n\nvar agentDict = flow.get(\"agentDict\");\n\ndelete dirTable[msg.payload.agent];\ndelete agentDict[msg.payload.agent];\n\nflow.set(\"agentDict\", agentDict);\nflow.set(\"dirTable\", dirTable);\n\nmsg.payload = 'Done <br> <br> <img src=\"http://www.fahrenheitmagazine.com/wp-content/uploads/2015/07/padrino.gif\"></img>';\nreturn msg;","outputs":1,"noerr":0,"x":340,"y":1960,"wires":[["14bceba0.e9aca4"]]},{"id":"88b62d78.6d0d28","type":"http in","z":"85ae90a6.827ac8","name":"","url":"/index","method":"get","upload":false,"swaggerDoc":"","x":140,"y":2060,"wires":[["140cd89.87f8ca7"]]},{"id":"140cd89.87f8ca7","type":"template","z":"85ae90a6.827ac8","name":"CSS","field":"payload.style","fieldType":"msg","format":"html","syntax":"mustache","template":"input[type=text], select {\n    width: 100%;\n    padding: 12px 20px;\n    margin: 8px 0;\n    display: inline-block;\n    border: 1px solid #ccc;\n    border-radius: 4px;\n    box-sizing: border-box;\n}\n\ninput[type=submit] {\n    width: 100%;\n    background-color: #4CAF50;\n    color: white;\n    padding: 14px 20px;\n    margin: 8px 0;\n    border: none;\n    border-radius: 4px;\n    cursor: pointer;\n}\n\nh1{\n    font-family:Monospace;\n    color:red;\n}\n\ninput[type=submit]:hover {\n    background-color: #45a049;\n}\n\n.formulario{\n    width: 40%;\n}\n\ndiv {\n    border-radius: 5px;\n    background-color: #f2f2f2;\n    padding: 20px;\n    text-align:center;\n    top:0;\n    bottom: 0;\n    left: 0;\n    right: 0;\n    margin: auto;\n}","output":"str","x":310,"y":2060,"wires":[["be2149bc.ffac2"]]},{"id":"be2149bc.ffac2","type":"template","z":"85ae90a6.827ac8","name":"HTML","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"<html>\n  <head>\n    <title>Index</title>\n    <meta name=\"viewport\" content=\"initial-scale=1.0, user-scalable=no\">\n    <meta charset=\"utf-8\">\n    <script src=\"http://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.0/jquery.min.js\"></script>\n    <style>{{{payload.style}}}</style>\n  </head>\n  \n\n    <h1 style=\"text-align:center\">Choose an option or die!</h1>\n\n<a href=\"http://clanjhoo.com:1880/create\">Create Agent.</a>\n<div class=\"formulario\">\n  \n</div>\n\n</body>\n</html>\n<script type=\"text/javascript\">\n</script>","output":"str","x":470,"y":2060,"wires":[["8395ef96.c6c0c8"]]},{"id":"8395ef96.c6c0c8","type":"http response","z":"85ae90a6.827ac8","name":"","statusCode":"","headers":{},"x":630,"y":2060,"wires":[]},{"id":"9653cd42.f0f088","type":"inject","z":"807487aa.61868","name":"TestNoXML","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"x":180,"y":1940,"wires":[["1e91576b.8b9e09"]]},{"id":"1e91576b.8b9e09","type":"function","z":"807487aa.61868","name":"CreateBad","func":"var mes = { Cd1: {\n    emisor: 'emi',\n    receptor: 'rece'}};\n\nmsg.payload = \"<?ada ////////> <ada>ad></ad>\";\nreturn msg;","outputs":1,"noerr":0,"x":190,"y":2020,"wires":[["f3b876d4.a41328"]]},{"id":"f3b876d4.a41328","type":"http request","z":"807487aa.61868","name":"SendBAD","method":"POST","ret":"txt","url":"localhost:1880","tls":"","x":360,"y":2020,"wires":[["f67a2f8.9ac0dd"]]},{"id":"f67a2f8.9ac0dd","type":"debug","z":"807487aa.61868","name":"Print Response","active":true,"console":"false","complete":"true","x":760,"y":2020,"wires":[]},{"id":"4468dc07.6fdc04","type":"catch","z":"807487aa.61868","name":"NotXML","scope":["97561ca8.5ff178"],"x":1230,"y":740,"wires":[["b911ed21.132308"]]},{"id":"b911ed21.132308","type":"function","z":"807487aa.61868","name":"NotXMLError","func":"msg.payload = \"The received body wasn't in XML format\"\nmsg.statusCode = 415\n\nvar lmesTS = flow.get(\"lmesTS\");\nvar d = new Date();\nlmesTS[msg.sender] = d.getTime() + 10 * 1000;\nflow.set(\"lmesTS\", lmesTS);\n\nreturn msg;","outputs":1,"noerr":0,"x":2330,"y":740,"wires":[["1b19cf15.4e4c91"]]},{"id":"89b0ff51.d03fa8","type":"switch","z":"807487aa.61868","name":"BadType","property":"known","propertyType":"msg","rules":[{"t":"true"},{"t":"else"}],"checkall":"true","outputs":2,"x":2320,"y":1740,"wires":[["eb1fff1a.9c40f"],["c4bae27e.1f3d28"]]},{"id":"eb1fff1a.9c40f","type":"function","z":"807487aa.61868","name":"BadFormat","func":"msg.statusCode = 400\nmsg.payload = \"Bad formatted \" + msg.type\n\nreturn msg;","outputs":1,"noerr":0,"x":2570,"y":1660,"wires":[["1b19cf15.4e4c91"]]},{"id":"c4bae27e.1f3d28","type":"function","z":"807487aa.61868","name":"UnknownType","func":"msg.statusCode = 418;\n//msg.topic = \"I'm a teapot\"\nmsg.payload = \"Any attempt to brew coffee \" + \n            \"with a teapot should result in \" + \n            \"the error code \" + '\"' + \"418 I'm\" +\n            \" a teapot\" + '\". The resulting ' +\n            \"entity body MAY be short and stout.\"\n\nreturn msg;","outputs":1,"noerr":0,"x":2580,"y":1740,"wires":[["1b19cf15.4e4c91"]]},{"id":"54c45fad.42821","type":"debug","z":"807487aa.61868","name":"RejectTime","active":false,"console":"false","complete":"reject","x":1230,"y":700,"wires":[]},{"id":"902da93.2cae9d8","type":"function","z":"807487aa.61868","name":"CheckRecentFails","func":"msg.sender = msg.req.headers.host + '&' + msg.req.ip;\nvar lmesTS = flow.get(\"lmesTS\");\nmsg.reject = 0;\nif (lmesTS[msg.sender] !== undefined) {\n    var d = new Date();\n    msg.reject = lmesTS[msg.sender] - d.getTime();\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":670,"y":680,"wires":[["124b5d22.420b9b"]]},{"id":"124b5d22.420b9b","type":"switch","z":"807487aa.61868","name":"MustReject?","property":"reject","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"str"},{"t":"else"}],"checkall":"true","outputs":2,"x":910,"y":680,"wires":[["3a282b6.9f3fe54","54c45fad.42821"],["cbabe595.d97f08","97561ca8.5ff178"]]},{"id":"3a282b6.9f3fe54","type":"function","z":"807487aa.61868","name":"TooManyRequests","func":"msg.payload = \"You must wait \" + msg.reject/1000 +\n              \" seconds before the next attempt\"\nmsg.statusCode = 429;\nif (msg.headers === undefined) {\n    msg.headers = {};\n}\nmsg.headers['Retry-After'] = msg.reject;\n\nreturn msg;","outputs":1,"noerr":0,"x":2310,"y":680,"wires":[["1b19cf15.4e4c91"]]},{"id":"8c831647.bcd898","type":"function","z":"807487aa.61868","name":"SetLMesTS","func":"var lmesTS = flow.get(\"lmesTS\");\nvar d = new Date();\nlmesTS[msg.sender] = d.getTime() + 5 * 1000;\nflow.set(\"lmesTS\", lmesTS);\n\nreturn msg;","outputs":1,"noerr":0,"x":1650,"y":1740,"wires":[["f3aa0a1d.c3602"]]},{"id":"c04a4b6b.5eb8e","type":"inject","z":"85ae90a6.827ac8","name":"Init","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":true,"x":1088.571533203125,"y":117.14286041259766,"wires":[["e314900f.0c011"]]},{"id":"e314900f.0c011","type":"function","z":"85ae90a6.827ac8","name":"Init Container","func":"class Agent { //Agente genrico\n    constructor(id){\n        this.id = id;\n        this.messages = [];\n    }\n    \n    sendMessage(message, destId) { // Funcion para enviar un mensaje\n        var agentDict = flow.get(\"agentDict\");\n        if (agentDict.hasOwnProperty(destId)){\n            agentDict[destId].receiveMessage(message, this.id, Date.now());\n            return true;\n        }\n        else\n        {\n            var send = flow.get(\"send\");\n            return send(message, destId, this.id, Date.now());\n        }\n    }\n    receiveMessage(message, senderId, time) {\n        this.messages.push({'sender': senderId, 'timestamp': time, 'message': message});\n    }\n}\n\n// Los clientes deben tener identificador y la lista de tiendas en las que han estado\n// De las tiendas se tiene la ip o hostname y puerto si es necesario\nclass Client {\n    constructor(id,d_shops){\n        this.id = id;\n        this.d_shops = d_shops;\n    }\n}\n\n\nclass Shop extends Agent {\n    constructor(id,d_products){\n        super(id);\n        this.id = id;\n        this.types = \"js\"; // shop type to send and receive\n        this.products = {}; // Products dictionary inizalizer\n        this.forum = 5; // shop avalaible space for clients\n        this.currentState = \"OnService\"; // shop initial state\n        this.states = [\"Onservice\",\"Chaos\"];\n        this.clientesInto = []; // Client list\n        // Si tenemos un aforo tenemos que tener en cuenta QUE personas estan dentro?\n        // Sobrecarga de Constructores\n        \n        // iterate array \n        for(var prod in d_products){\n            this.products[prod[\"identifP\"]] ={\n                name:  prod[\"nombreP\"],\n                stock: prod[\"cantidadP\"]\n            };\n        }\n    }\n    \n    checkForum(){\n        var agentDict = flow.get(\"agentDict\");\n        if(Object.keys(agentDict).length > this.forum){\n            return false;\n        }\n        return true;\n    }\n    \n    // client petition to take some items\n    sellItems(clienteID,dict_products){\n        newlist = {};\n        if(checkForum()){\n            newlist = {};\n            // iterate client list\n            for(var prod in dict_products){\n                if (dict_product.hasOwnProperty(prod)) {\n                    if(this.products.hasOwnProperty(prod)){\n                        // we have enough units of product\n                        if(this.products[prod] >= dict_product[prod]){\n                            this.products[prod] = this.products[prod] - dict_product[prod];\n                            newlist.push({\n                                prod : this.products[prod] - dict_product[prod]\n                            });\n                        }\n                    \n                    }\n                }\n            }\n        }\n        return newlist;\n    }\n    \n    // Client do a petition to know other clients\n    clientsListPetition(clientID){\n        return clientesInto;\n    }\n    \n    sendstate(monitorID){\n        return this.currentState;\n    }\n    \n}\n\nclass TimeAgent extends Agent {\n    constructor(id) {\n        super(id);\n    }\n    getTime(){\n        var date = new Date();\n        // Hours part from the timestamp\n        var hours = date.getUTCHours();\n        // Minutes part from the timestamp\n        var minutes = \"0\" + date.getUTCMinutes();\n        // Seconds part from the timestamp\n        var seconds = \"0\" + date.getUTCSeconds();\n        \n        // Will display time in 10:30:23 format\n        var formattedTime = hours + ':' + minutes.substr(-2) + ':' + seconds.substr(-2);\n        \n        return formattedTime;\n    }\n    receiveMessage(message, senderId, time) {\n        super.receiveMessage (message, senderId, time);\n        super.sendMessage (this.getTime(), senderId);\n    }\n}\n\nfunction addAgent(name) { // Dar de alta un agente en el contenedor\n    var Agent = flow.get(\"Agent\");\n    var TimeAgent = flow.get(\"TimeAgent\");\n    var lastId = flow.get(\"lastId\");\n    var hostname = flow.get(\"hostname\");\n    var port = flow.get(\"port\");\n    var agentDict = flow.get(\"agentDict\");\n    var dirTable = flow.get(\"dirTable\");\n    \n    var time = Date.now().toString();\n    var newId = hostname.concat(\":\").concat(port).concat(\":\").concat(time).concat(\":\").concat(lastId.toString());\n    if (lastId === 0)\n    {\n        ag = new TimeAgent(newId, name);\n    }\n    else\n    {\n        ag = new Agent(newId, name);\n    }\n    lastId++;\n    agentDict[newId] = ag;\n    dirTable[newId] = {\"hostname\": hostname, \"port\": port}\n    \n    flow.set(\"lastId\", lastId);\n    flow.set(\"agentDict\", agentDict);\n    flow.set(\"dirTable\", dirTable);\n}\n\nfunction remAgent(id) {\n    var agentDict = flow.get(\"agentDict\");\n    \n    delete agentDict[id];\n    \n    flow.set(\"agentDict\", agentDict);\n}\n\nfunction send(message, destId, senderId, time)\n{\n    var dirTable = flow.get(\"dirTable\");\n    if (dirTable.hasOwnProperty(destId)){\n        return [dirTable[destId], {'message': message, 'destId': destId, 'senderId': senderId, 'timestamp': time}];\n    }\n    return false;\n}\n\n\nflow.set(\"Agent\", Agent);\nflow.set(\"TimeAgent\", TimeAgent);\nflow.set(\"addAgent\", addAgent);\nflow.set(\"remAgent\", remAgent);\nflow.set(\"send\", send);\nflow.set(\"agentDict\", {});\nflow.set(\"dirTable\", {});\nflow.set(\"lastId\", 0);\nflow.set(\"hostname\", \"practis.clanjhoo.com\");\nflow.set(\"port\", \"1880\");\nflow.set(\"Shop\",Shop);\nflow.set(\"ourShop\", new Shop());\nflow.set(\"lmesTS\", {});\n\nreturn msg;","outputs":1,"noerr":0,"x":1308.571533203125,"y":117.14286041259766,"wires":[["7bccc5ab.c4983c"]]},{"id":"ec97ae3b.80c77","type":"debug","z":"85ae90a6.827ac8","name":"","active":true,"console":"false","complete":"false","x":1688.571533203125,"y":337.14286041259766,"wires":[]},{"id":"2f499354.8b9d34","type":"inject","z":"85ae90a6.827ac8","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"x":1098.571533203125,"y":337.14286041259766,"wires":[["6788f963.b9ad18"]]},{"id":"6788f963.b9ad18","type":"function","z":"85ae90a6.827ac8","name":"","func":"msg.payload = flow.get(\"agentDict\");\n\nreturn msg;","outputs":1,"noerr":0,"x":1248.571533203125,"y":337.14286041259766,"wires":[["3526f7c7.6b7f58"]]},{"id":"e32201d7.e29f68","type":"comment","z":"85ae90a6.827ac8","name":"View Agents","info":"","x":1528.571533203125,"y":337.14286041259766,"wires":[]},{"id":"4b3ba009.4299f","type":"inject","z":"85ae90a6.827ac8","name":"AddAgent","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"x":1098.571533203125,"y":177.14286041259766,"wires":[["7bccc5ab.c4983c"]]},{"id":"7bccc5ab.c4983c","type":"function","z":"85ae90a6.827ac8","name":"Init Container","func":"var ourShop = flow.get(\"ourShop\");\nvar addAgent = flow.get(\"addAgent\");\nvar lastId = flow.get(\"lastId\");\n\naddAgent('A' + lastId.toString());\naddAgent('A' + (lastId + 1).toString());\n\nreturn msg;","outputs":1,"noerr":0,"x":1308.571533203125,"y":177.14286041259766,"wires":[[]]},{"id":"3526f7c7.6b7f58","type":"json","z":"85ae90a6.827ac8","name":"","pretty":false,"x":1388.571533203125,"y":337.14286041259766,"wires":[["ec97ae3b.80c77"]]},{"id":"969a350b.9a86f8","type":"inject","z":"85ae90a6.827ac8","name":"Reset Container","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"x":1118.571533203125,"y":257.14286041259766,"wires":[["8aad4550.b327f8"]]},{"id":"8aad4550.b327f8","type":"function","z":"85ae90a6.827ac8","name":"Reset Agents","func":"flow.set(\"agentDict\", {});\nflow.set(\"dirTable\", {});\n\nreturn msg;","outputs":1,"noerr":0,"x":1338.571533203125,"y":257.14286041259766,"wires":[[]]},{"id":"97561ca8.5ff178","type":"xml","z":"807487aa.61868","name":"ParseXML","attr":"","chr":"","x":1230,"y":760,"wires":[["3caac0ab.095648"]]},{"id":"3caac0ab.095648","type":"function","z":"807487aa.61868","name":"SetType","func":"var keys = Object.keys(msg.payload);\nmsg.known = true;\nmsg.type = keys[0];\n\nif ((msg.payload.CT1 === undefined  &&\n     msg.payload.CT4 === undefined  &&\n     msg.payload.CT6 === undefined  &&\n     msg.payload.MT1 === undefined  &&\n     msg.payload.MT3 === undefined  &&\n     msg.payload.MT5 === undefined) ||\n    keys.length !== 1)\n{\n    msg.known = false;\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":680,"y":860,"wires":[["4085139c.017174"]]},{"id":"4b71b015.e1af6","type":"function","z":"807487aa.61868","name":"FixRecvObject","func":"function rUlness(col)\n{\n    var t = typeof col;\n    if (t === \"object\")\n    {\n        if (col.hasOwnProperty('length'))\n        {\n            for (var i = 0; i < col.length; i++) {\n                col[i] = rUlness(col[i]);\n            }\n            if (col.length === 1)\n            {\n                col = col[0]\n            }\n        }\n        else\n        {\n            for (var key in col) {\n                col[key] = rUlness(col[key]);\n            }\n        }\n    }\n    return col;\n}\n\nmsg.payload = rUlness(msg.payload);\nmsg.statusCode = 200;\n\nreturn msg;","outputs":1,"noerr":0,"x":680,"y":940,"wires":[["84e5dfc3.3fd5f8"]]},{"id":"4085139c.017174","type":"switch","z":"807487aa.61868","name":"UnknownType?","property":"known","propertyType":"msg","rules":[{"t":"true"},{"t":"else"}],"checkall":"true","outputs":2,"x":440,"y":940,"wires":[["4b71b015.e1af6"],["8c831647.bcd898","2ed88a86.6c45ae"]]},{"id":"84e5dfc3.3fd5f8","type":"function","z":"807487aa.61868","name":"CheckHeader","func":"msg.check = true;\nvar nkeys = Object.keys(msg.payload[msg.type]).length;\n\nif ((nkeys === 4 && msg.type === \"MT1\") ||\n    (nkeys === 5 && msg.type === \"CT1\") ||\n    (nkeys === 3 && msg.type !== \"MT1\" && msg.type === \"CT1\"))\n{\n    if (typeof msg.payload[msg.type].emisor !== \"string\"         ||\n        typeof msg.payload[msg.type].receptor !== \"string\"       ||\n        typeof msg.payload[msg.type].time !== \"object\"           ||\n        typeof msg.payload[msg.type].time.timestamp !== \"string\" ||\n        typeof msg.payload[msg.type].time.creador !== \"string\"   ||\n        Object.keys(msg.payload[msg.type].time).length !== 2      )\n    {\n        msg.check = false;\n    }\n    else\n    {\n        var ts = parseInt(msg.payload[msg.type].time.timestamp);\n        if (ts != msg.payload[msg.type].time.timestamp)\n        {\n            msg.check = false;\n        }\n        else\n        {\n            msg.payload[msg.type].time.timestamp = ts;\n        }\n    }\n}\n\nmsg.listaP = msg.type === \"CT1\" || msg.type === \"MT1\";\nmsg.listaT = msg.type === \"CT1\";\n\nreturn msg;","outputs":1,"noerr":0,"x":900,"y":940,"wires":[["b608db94.f2503"]]},{"id":"b608db94.f2503","type":"switch","z":"807487aa.61868","name":"IsHeaderOk?","property":"check","propertyType":"msg","rules":[{"t":"true"},{"t":"else"}],"checkall":"true","outputs":2,"x":430,"y":1040,"wires":[["865519ba.418558"],["8c831647.bcd898","d7113a06.2b3e1"]]},{"id":"865519ba.418558","type":"switch","z":"807487aa.61868","name":"HasListaP?","property":"listaP","propertyType":"msg","rules":[{"t":"false"},{"t":"else"}],"checkall":"true","outputs":2,"x":790,"y":1040,"wires":[["ed6c2dea.0efee8","92225be1.3508c8"],["f9956506.564a08"]]},{"id":"f9956506.564a08","type":"function","z":"807487aa.61868","name":"CheckListaP","func":"msg.zcant = false;\n\nif (msg.payload[msg.type].listaP !== undefined)\n{\n    var p = msg.payload[msg.type].listaP.producto;\n    \n    if (p !== undefined) {\n        if (p.length !== undefined) {\n            for (let i = 0; i < p.length; i++) {\n                if (typeof p[i].nombre === \"string\" &&\n                    typeof p[i].cantidad === \"string\" &&\n                    Object.keys(p[i]).length === 2)\n                {\n                    var cant = parseInt(p[i].cantidad);\n                    \n                    if (cant != p[i].cantidad)\n                    {\n                        msg.check = false;\n                        break;\n                    }\n                    else\n                    {\n                        msg.zcant = cant <= 0 || msg.zcant;\n                        if (msg.zcant) {\n                            break;\n                        }\n                    }\n                    \n                    msg.payload[msg.type].listaP.producto[i].cantidad = cant;\n                }\n                else\n                {\n                    msg.check = false;\n                    break;\n                }\n            }\n            \n            msg.zcant = p.length === 0 || msg.zcant;\n        } else {\n            msg.check = false;\n        }\n    }\n    else\n    {\n        msg.zcant = true;\n    }\n}\nelse\n{\n    msg.check = false;\n}\n\nif (msg.check)\n{\n    \n}\n\n\nreturn msg;","outputs":1,"noerr":0,"x":890,"y":1100,"wires":[["3635fa54.2fca8e"]]},{"id":"a33ecd34.60f678","type":"xml","z":"d6e86490.4f832","name":"ParseXML","attr":"","chr":"","x":957.1429443359375,"y":508.5714416503906,"wires":[["565a4b83.e66bec"]]},{"id":"565a4b83.e66bec","type":"function","z":"d6e86490.4f832","name":"FixRecvObject","func":"function rUlness(col)\n{\n    var t = typeof col\n    if (t === \"object\")\n    {\n        if (col.hasOwnProperty('length'))\n        {\n            for (var i = 0; i < col.length; i++) {\n                col[i] = rUlness(col[i]);\n            }\n            if (col.length === 1)\n            {\n                col = col[0]\n            }\n        }\n        else\n        {\n            for (var key in col) {\n                if (col.hasOwnProperty(key)) {\n                    col[key] = rUlness(col[key]);\n                }\n            }\n        }\n    }\n    return col;\n}\n\nmsg.payload = rUlness(msg.payload)\n\nreturn msg;","outputs":1,"noerr":0,"x":1172.71435546875,"y":478.9999694824219,"wires":[["279e9ab3.9e436e"]]},{"id":"161aea83.c232fd","type":"xml-validate","z":"d6e86490.4f832","name":"ValidateCT1","filename":".node-red/xsd-schemas/CliTie/CT1.xsd","x":437.1429443359375,"y":208.57144165039062,"wires":[["79f15bfe.28eb44"],["bae46ef7.d6034"],["f6ad1df2.cf46e8"]]},{"id":"d14ef49.5eb3b08","type":"xml-validate","z":"d6e86490.4f832","name":"ValidateCT6","filename":".node-red/xsd-schemas/CliTie/CT6.xsd","x":437.1429443359375,"y":448.5714416503906,"wires":[["b309853d.85f61"],["188d89dd.b5cc3e"],["20b012e2.d4b8fe"]]},{"id":"bae46ef7.d6034","type":"xml-validate","z":"d6e86490.4f832","name":"ValidateCT4","filename":".node-red/xsd-schemas/CliTie/CT4.xsd","x":437.1429443359375,"y":328.5714416503906,"wires":[["2bb5c382.6a3a64"],["d14ef49.5eb3b08"],["d2b04ff.750013"]]},{"id":"188d89dd.b5cc3e","type":"xml-validate","z":"d6e86490.4f832","name":"ValidateMT1","filename":".node-red/xsd-schemas/MonTie/MT1.xsd","x":437.1429443359375,"y":568.5714416503906,"wires":[["c6b86a86.40d3b"],["d7f4faf2.db7a88"],["92cd9c5a.0024c"]]},{"id":"d7f4faf2.db7a88","type":"xml-validate","z":"d6e86490.4f832","name":"ValidateMT3","filename":".node-red/xsd-schemas/MonTie/MT3.xsd","x":437.1429443359375,"y":688.5714416503906,"wires":[["f844fa01.8b03b"],["a6902436.0d4ce"],["dfd29854.dd432"]]},{"id":"a6902436.0d4ce","type":"xml-validate","z":"d6e86490.4f832","name":"ValidateMT5","filename":".node-red/xsd-schemas/MonTie/MT5.xsd","x":437.1429443359375,"y":808.5714416503906,"wires":[["f1239ddb.a4d47"],[],["a3851d05.045af"]]},{"id":"279e9ab3.9e436e","type":"debug","z":"d6e86490.4f832","name":"ViewObject","active":false,"console":"false","complete":"payload","x":1150.1429443359375,"y":337.1428527832031,"wires":[]},{"id":"79f15bfe.28eb44","type":"function","z":"d6e86490.4f832","name":"SetCT1Type","func":"msg.type = \"CT1\"\n\nreturn msg;","outputs":1,"noerr":0,"x":677.1429443359375,"y":308.5714416503906,"wires":[["a33ecd34.60f678"]]},{"id":"2bb5c382.6a3a64","type":"function","z":"d6e86490.4f832","name":"SetCT4Type","func":"msg.type = \"CT4\"\n\nreturn msg;","outputs":1,"noerr":0,"x":677.1429443359375,"y":388.5714416503906,"wires":[["a33ecd34.60f678"]]},{"id":"b309853d.85f61","type":"function","z":"d6e86490.4f832","name":"SetCT6Type","func":"msg.type = \"CT6\"\n\nreturn msg;","outputs":1,"noerr":0,"x":677.1429443359375,"y":468.5714416503906,"wires":[["a33ecd34.60f678"]]},{"id":"c6b86a86.40d3b","type":"function","z":"d6e86490.4f832","name":"SetMT1Type","func":"msg.type = \"MT1\"\n\nreturn msg;","outputs":1,"noerr":0,"x":677.1429443359375,"y":548.5714416503906,"wires":[["a33ecd34.60f678"]]},{"id":"f844fa01.8b03b","type":"function","z":"d6e86490.4f832","name":"SetMT3Type","func":"msg.type = \"MT3\"\n\nreturn msg;","outputs":1,"noerr":0,"x":677.1429443359375,"y":628.5714416503906,"wires":[["a33ecd34.60f678"]]},{"id":"f1239ddb.a4d47","type":"function","z":"d6e86490.4f832","name":"SetMT5Type","func":"msg.type = \"MT5\"\n\nreturn msg;","outputs":1,"noerr":0,"x":677.1429443359375,"y":708.5714416503906,"wires":[["a33ecd34.60f678"]]},{"id":"f8afdda0.3e5cf","type":"comment","z":"d6e86490.4f832","name":"Unknown Message","info":"Unexpected type of message received.\nWe should try to guess the type or check whether\nit's an XML or not.","x":642.8572387695312,"y":807.1429138183594,"wires":[]},{"id":"f6ad1df2.cf46e8","type":"debug","z":"d6e86490.4f832","name":"CT1ValError","active":false,"console":"false","complete":"payload","x":222.28582763671875,"y":210.85708618164062,"wires":[]},{"id":"d2b04ff.750013","type":"debug","z":"d6e86490.4f832","name":"CT4ValError","active":false,"console":"false","complete":"payload","x":216.571533203125,"y":330.2856750488281,"wires":[]},{"id":"20b012e2.d4b8fe","type":"debug","z":"d6e86490.4f832","name":"CT6ValError","active":false,"console":"false","complete":"payload","x":215.14297485351562,"y":447.4286193847656,"wires":[]},{"id":"92cd9c5a.0024c","type":"debug","z":"d6e86490.4f832","name":"MT1ValError","active":false,"console":"false","complete":"payload","x":215.14297485351562,"y":563.1427307128906,"wires":[]},{"id":"dfd29854.dd432","type":"debug","z":"d6e86490.4f832","name":"MT3ValError","active":false,"console":"false","complete":"payload","x":213.71438598632812,"y":684.5713195800781,"wires":[]},{"id":"a3851d05.045af","type":"debug","z":"d6e86490.4f832","name":"MT5ValError","active":false,"console":"false","complete":"payload","x":216.571533203125,"y":807.4284973144531,"wires":[]},{"id":"a6e27419.5b01e8","type":"xml","z":"d6e86490.4f832","name":"UnknownXML","attr":"","chr":"","x":891.4285888671875,"y":937.1429443359375,"wires":[["5ff344a2.99845c"]]},{"id":"5ff344a2.99845c","type":"function","z":"d6e86490.4f832","name":"Get root tag","func":"msg.type = Object.keys(msg.payload)[0];\nvar validArr = [\"CT1\", \"CT4\", \"CT6\",\n                \"MT1\", \"MT3\", \"MT5\"];\nmsg.isValid = (validArr.indexOf(msg.type) > -1);\n\nreturn msg;","outputs":1,"noerr":0,"x":1141.28564453125,"y":939.1429443359375,"wires":[[]]},{"id":"3635fa54.2fca8e","type":"switch","z":"807487aa.61868","name":"IsListaPOk?","property":"check","propertyType":"msg","rules":[{"t":"true"},{"t":"else"}],"checkall":"true","outputs":2,"x":430,"y":1180,"wires":[["f9aa303d.6eae68"],["8c831647.bcd898","b5290362.939c98"]]},{"id":"5053901c.4a7fe8","type":"switch","z":"807487aa.61868","name":"HasListaT?","property":"listaT","propertyType":"msg","rules":[{"t":"false"},{"t":"else"}],"checkall":"true","outputs":2,"x":990,"y":1180,"wires":[["45d120ef.0b208","692716aa.20a4e8"],["7198ff72.f6cec"]]},{"id":"7198ff72.f6cec","type":"function","z":"807487aa.61868","name":"CheckListaT","func":"if (msg.payload[msg.type].listaT !== undefined)\n{\n    var t = msg.payload[msg.type].listaT.tienda;\n    \n    if (t !== undefined) {\n        if (t.length !== undefined) {\n            for (let i = 0; i < t.length; i++) {\n                if (typeof t[i].idTienda !== \"string\" ||\n                    typeof t[i].direccion !== \"string\" ||\n                    (t[i].tipo !== \"php\" &&\n                     t[i].tipo !== \"py\" &&\n                     t[i].tipo !== \"js\") ||\n                    Object.keys(t[i]).length !== 3)\n                {\n                    msg.check = false;\n                    break;\n                }\n            }\n            \n            msg.zcant = t.length === 0 || msg.zcant;\n        } else {\n            msg.check = false;\n        }\n    } else {\n        msg.zcant = true;\n    }\n}\nelse\n{\n    msg.check = false;\n}\n\n\nreturn msg;","outputs":1,"noerr":0,"x":1150,"y":1240,"wires":[["4651f228.811bac"]]},{"id":"4651f228.811bac","type":"switch","z":"807487aa.61868","name":"IsListaTOk?","property":"check","propertyType":"msg","rules":[{"t":"true"},{"t":"else"}],"checkall":"true","outputs":2,"x":1210,"y":1340,"wires":[["8878e8e4.2323e8"],["8c831647.bcd898","f171d13d.42b148"]]},{"id":"2ed88a86.6c45ae","type":"debug","z":"807487aa.61868","name":"Unknown","active":false,"console":"false","complete":"payload","x":200,"y":940,"wires":[]},{"id":"d7113a06.2b3e1","type":"debug","z":"807487aa.61868","name":"HeaderFail","active":false,"console":"false","complete":"payload","x":210,"y":1040,"wires":[]},{"id":"b5290362.939c98","type":"debug","z":"807487aa.61868","name":"ListaPFail","active":false,"console":"false","complete":"payload","x":200,"y":1180,"wires":[]},{"id":"f171d13d.42b148","type":"debug","z":"807487aa.61868","name":"ListaTFail","active":false,"console":"false","complete":"payload","x":200,"y":1340,"wires":[]},{"id":"f3aa0a1d.c3602","type":"switch","z":"807487aa.61868","name":"Error","property":"statusCode","propertyType":"msg","rules":[{"t":"gte","v":"400","vt":"str"},{"t":"else"}],"checkall":"true","outputs":2,"x":2090,"y":1740,"wires":[["1b19cf15.4e4c91"],["89b0ff51.d03fa8"]]},{"id":"92225be1.3508c8","type":"debug","z":"807487aa.61868","name":"CT4-6 or MT3-5 Message","active":false,"console":"false","complete":"payload","x":1090,"y":980,"wires":[]},{"id":"45d120ef.0b208","type":"debug","z":"807487aa.61868","name":"MT1Message","active":false,"console":"false","complete":"payload","x":1160,"y":1120,"wires":[]},{"id":"341819e.54f2466","type":"debug","z":"807487aa.61868","name":"CT1Message","active":false,"console":"false","complete":"payload","x":1455.9998779296875,"y":1262.6666259765625,"wires":[]},{"id":"f9aa303d.6eae68","type":"switch","z":"807487aa.61868","name":"zListaP","property":"zcant","propertyType":"msg","rules":[{"t":"false"},{"t":"else"}],"checkall":"true","outputs":2,"x":640,"y":1180,"wires":[["5053901c.4a7fe8"],["cd15f361.d7489"]]},{"id":"cd15f361.d7489","type":"function","z":"807487aa.61868","name":"QuantityZero","func":"msg.statusCode = 422;\nmsg.payload = \"Zero products (CT1 and MT1), zero quantity (CT1 and MT1) or zero shops (CT1) are not allowed\";\n\nreturn msg;","outputs":1,"noerr":0,"x":1330,"y":1740,"wires":[["8c831647.bcd898"]]},{"id":"8878e8e4.2323e8","type":"switch","z":"807487aa.61868","name":"zListaT","property":"zcant","propertyType":"msg","rules":[{"t":"false"},{"t":"else"}],"checkall":"true","outputs":2,"x":1480,"y":1340,"wires":[["4c0767b0.b0c21","341819e.54f2466"],["cd15f361.d7489"]]},{"id":"8d9d42c.b12124","type":"catch","z":"807487aa.61868","name":"InternalError","scope":["84e5dfc3.3fd5f8","f9956506.564a08","7198ff72.f6cec","902da93.2cae9d8","4c0767b0.b0c21","ad5420d1.caddb","9ad7c557.1c4338","4b71b015.e1af6","692716aa.20a4e8","21822a70.1c10c6","2a76775b.3c4388","3caac0ab.095648","a79953d8.20a52","c791f029.0e889","37599c64.042574","9369f46d.841218","cc2c4b6f.efe41","f679bc08.786008","a79c1d00.9b0f08","2bae27b2.9fac4","4c9b081c.8951","1530292a.4510e7","2f7eff97.e88708"],"x":2250,"y":800,"wires":[["6b404da6.3654c4","d3188f06.67a96"]]},{"id":"6b404da6.3654c4","type":"function","z":"807487aa.61868","name":"InternalServerError","func":"msg.statusCode = 500;\n\nreturn msg;","outputs":1,"noerr":0,"x":2310,"y":800,"wires":[["1b19cf15.4e4c91"]]},{"id":"494d2960.ee9bb","type":"function","z":"d6e86490.4f832","name":"Answer","func":"//msg.payload['TC2'] = msg.payload['CT1']\n//delete msg.payload['CT1']\n\n/*\ndict.push({\n    key:   \"keyName\",\n    value: \"the value\"\n});\n*/\nvar d = new Date();\n\nvar time = [{timestamp: d.getTime(),creador:\"clanjhoo.com:1880\"}];\n\nfor (var key in msg.payload) {\n    if (msg.payload.hasOwnProperty(key)) {\n        if(key=='CT1'){\n            for (var lb in msg.payload[key]) {\n                if (msg.payload.hasOwnProperty(key)) {\n                    if(lb === \"emisor\"){\n                        var receptorR = msg.payload[key][lb][\"emisor\"]\n                    }\n                    if(lb === \"receptor\"){\n                        var emisorR = msg.payload[key][lb][\"receptor\"]\n                    }\n                    //msg.payload[key][lb] = msg.payload[key][lb]\n                    /*\n                    if (lb === \"time\") {\n                        msg.payload[key][lb][\"timestamp\"] = msg.payload[key][lb][\"timestamp\"][0]\n                        msg.payload[key][lb][\"creador\"] = msg.payload[key][lb][\"creador\"][0]\n                    }\n                    */\n                    if (lb === \"listaP\") {\n                        /*\n                        for(var prod in msg.payload[key][lb]){ // [0]?\n                            \n                            if(prod == \"producto\"){\n                                nom_producto = msg.payload[key][lb][prod][\"nombre\"][0]\n                                cant_producto = msg.payload[key][lb][prod][\"cantidad\"][0]\n                            }\n                            // insertar codigo para preparar mensajes con productos por cada producto\n                            \n                        }\n                        */\n                        var listaCompradoR = msg.payload[key][lb]\n                    }\n                }\n            }\n            msg.payload = []\n            msg.payload['TC3'] = []\n            var emisor = [{emisor: emisorR}];\n            var receptor = [{receptor: receptorR}];\n            var listaComprado = [{listaComprado: listaCompradoR}];\n            msg.payload['TC3'].push([{emisor: emisor}]);\n            msg.payload['TC3'].push([{receptor: receptor}]);\n            msg.payload['TC3'].push([{time: time}]);\n            msg.payload['TC3'].push([{listaComprado: listaComprado}]);\n            return msg;\n        }\n        if(key=='MT1'){\n            for (var lb in msg.payload[key]) {\n                if (msg.payload.hasOwnProperty(key)) {\n                    msg.payload[key][lb] = msg.payload[key][lb][0]\n                    if (lb === \"time\") {\n                        msg.payload[key][lb][\"timestamp\"] = msg.payload[key][lb][\"timestamp\"][0]\n                        msg.payload[key][lb][\"creador\"] = msg.payload[key][lb][\"creador\"][0]\n                    }\n                }\n            }\n            return msg;\n        }\n        if(key=='MT3'){\n            for (var lb in msg.payload[key]) {\n                if (msg.payload.hasOwnProperty(key)) {\n                    msg.payload[key][lb] = msg.payload[key][lb][0]\n                    if (lb === \"time\") {\n                        msg.payload[key][lb][\"timestamp\"] = msg.payload[key][lb][\"timestamp\"][0]\n                        msg.payload[key][lb][\"creador\"] = msg.payload[key][lb][\"creador\"][0]\n                    }\n                }\n            }\n            return msg;\n        }\n        if(key=='MT5'){\n            for (var lb in msg.payload[key]) {\n                if (msg.payload.hasOwnProperty(key)) {\n                    msg.payload[key][lb] = msg.payload[key][lb][0]\n                    if (lb === \"time\") {\n                        msg.payload[key][lb][\"timestamp\"] = msg.payload[key][lb][\"timestamp\"][0]\n                        msg.payload[key][lb][\"creador\"] = msg.payload[key][lb][\"creador\"][0]\n                    }\n                }\n            }\n            return msg;\n        }\n        delete msg.payload[key]\n        msg.payload[\"error\"] = \"mensaje no esperado\";\n    }\n}\nreturn msg;","outputs":1,"noerr":0,"x":660,"y":940,"wires":[[]]},{"id":"d4b73bc8.89135","type":"http in","z":"d6e86490.4f832","name":"Tea","url":"/tea","method":"get","upload":false,"swaggerDoc":"","x":210,"y":1180,"wires":[["d0b143e5.1565f8"]]},{"id":"7954e0d2.34dec8","type":"http response","z":"d6e86490.4f832","name":"","statusCode":"","headers":{},"x":630,"y":1180,"wires":[]},{"id":"d0b143e5.1565f8","type":"function","z":"d6e86490.4f832","name":"","func":"msg.statusCode = 418;\nmsg.payload = \"ERROR 418: I'm a teapot.\"\nreturn msg;","outputs":1,"noerr":0,"x":411.99993896484375,"y":1179.999755859375,"wires":[["7954e0d2.34dec8","cd07fded.a56748"]]},{"id":"cd07fded.a56748","type":"debug","z":"d6e86490.4f832","name":"","active":true,"console":"false","complete":"false","x":518.9999389648438,"y":1090.999755859375,"wires":[]},{"id":"b215e760.701028","type":"switch","z":"807487aa.61868","name":"CT1Ok?","property":"statusCode","propertyType":"msg","rules":[{"t":"eq","v":"200","vt":"str"},{"t":"else"}],"checkall":"true","outputs":2,"x":1880,"y":1340,"wires":[["47606191.e53338","a79c1d00.9b0f08"],["3ff15041.ade288"]]},{"id":"6d1d51fe.ab4788","type":"switch","z":"807487aa.61868","name":"MT1Ok?","property":"statusCode","propertyType":"msg","rules":[{"t":"eq","v":"200","vt":"str"},{"t":"else"}],"checkall":"true","outputs":2,"x":1880,"y":1220,"wires":[["1530292a.4510e7","47606191.e53338"],["3ff15041.ade288"]]},{"id":"7d0667a0.2fb888","type":"switch","z":"807487aa.61868","name":"MT5Ok?","property":"statusCode","propertyType":"msg","rules":[{"t":"eq","v":"200","vt":"str"},{"t":"else"}],"checkall":"true","outputs":2,"x":1880,"y":1140,"wires":[["1b19cf15.4e4c91","47606191.e53338"],["3ff15041.ade288"]]},{"id":"90688579.10e32","type":"switch","z":"807487aa.61868","name":"MT3Ok?","property":"statusCode","propertyType":"msg","rules":[{"t":"eq","v":"200","vt":"str"},{"t":"else"}],"checkall":"true","outputs":2,"x":1880,"y":1060,"wires":[["2f7eff97.e88708","47606191.e53338"],["3ff15041.ade288"]]},{"id":"22561c2a.344844","type":"switch","z":"807487aa.61868","name":"CT6Ok?","property":"statusCode","propertyType":"msg","rules":[{"t":"eq","v":"200","vt":"str"},{"t":"else"}],"checkall":"true","outputs":2,"x":1880,"y":980,"wires":[["4c9b081c.8951","47606191.e53338"],["3ff15041.ade288"]]},{"id":"5281ddc6.1863b4","type":"switch","z":"807487aa.61868","name":"CT4Ok?","property":"statusCode","propertyType":"msg","rules":[{"t":"eq","v":"200","vt":"str"},{"t":"else"}],"checkall":"true","outputs":2,"x":1880,"y":900,"wires":[["2bae27b2.9fac4","47606191.e53338"],["3ff15041.ade288"]]},{"id":"3ff15041.ade288","type":"function","z":"807487aa.61868","name":"JOIN","func":"\nreturn msg;","outputs":1,"noerr":0,"x":2050,"y":1420,"wires":[["8c831647.bcd898"]]},{"id":"698d7264.3788fc","type":"switch","z":"807487aa.61868","name":"TC2-TC3?","property":"type","propertyType":"msg","rules":[{"t":"eq","v":"3","vt":"num"},{"t":"else"}],"checkall":"true","outputs":2,"x":2070,"y":1340,"wires":[["c791f029.0e889"],["a79953d8.20a52"]]},{"id":"2bae27b2.9fac4","type":"xml","z":"807487aa.61868","name":"WriteTC5","attr":"","chr":"","x":2040,"y":900,"wires":[["37599c64.042574"]]},{"id":"4c9b081c.8951","type":"xml","z":"807487aa.61868","name":"WriteTC7","attr":"","chr":"","x":2040,"y":980,"wires":[["9369f46d.841218"]]},{"id":"2f7eff97.e88708","type":"xml","z":"807487aa.61868","name":"WriteTM4","attr":"","chr":"","x":2040,"y":1060,"wires":[["f679bc08.786008"]]},{"id":"1530292a.4510e7","type":"xml","z":"807487aa.61868","name":"WriteTM2","attr":"","chr":"","x":2040,"y":1220,"wires":[["cc2c4b6f.efe41"]]},{"id":"a79c1d00.9b0f08","type":"xml","z":"807487aa.61868","name":"WriteTC2-3","attr":"","chr":"","x":2050,"y":1340,"wires":[["698d7264.3788fc"]]},{"id":"37599c64.042574","type":"xml-validate","z":"807487aa.61868","name":"ValidateTC5","filename":".node-red/xsd-schemas/CliTie/TC5.xsd","x":2230,"y":900,"wires":[["1b19cf15.4e4c91","6d91a05f.ea87d8"],["6b404da6.3654c4"],["ee539769.74114"]]},{"id":"9369f46d.841218","type":"xml-validate","z":"807487aa.61868","name":"ValidateTC7","filename":".node-red/xsd-schemas/CliTie/TC7.xsd","x":2230,"y":980,"wires":[["1b19cf15.4e4c91","6d91a05f.ea87d8"],["6b404da6.3654c4"],["ee539769.74114"]]},{"id":"f679bc08.786008","type":"xml-validate","z":"807487aa.61868","name":"ValidateTM4","filename":".node-red/xsd-schemas/MonTie/TM4.xsd","x":2230,"y":1060,"wires":[["1b19cf15.4e4c91"],["6b404da6.3654c4"],["ee539769.74114"]]},{"id":"cc2c4b6f.efe41","type":"xml-validate","z":"807487aa.61868","name":"ValidateTM2","filename":".node-red/xsd-schemas/MonTie/TM2.xsd","x":2230,"y":1220,"wires":[["1b19cf15.4e4c91"],["6b404da6.3654c4"],["ee539769.74114"]]},{"id":"c791f029.0e889","type":"xml-validate","z":"807487aa.61868","name":"ValidateTC3","filename":".node-red/xsd-schemas/CliTie/TC3.xsd","x":2230,"y":1300,"wires":[["1b19cf15.4e4c91","6d91a05f.ea87d8"],["6b404da6.3654c4"],["ee539769.74114"]]},{"id":"a79953d8.20a52","type":"xml-validate","z":"807487aa.61868","name":"ValidateTC2","filename":".node-red/xsd-schemas/CliTie/TC2.xsd","x":2230,"y":1380,"wires":[["1b19cf15.4e4c91","6d91a05f.ea87d8"],["6b404da6.3654c4"],["ee539769.74114"]]},{"id":"ee539769.74114","type":"debug","z":"807487aa.61868","name":"ValidationErrors","active":false,"console":"false","complete":"payload","x":2300,"y":1480,"wires":[]},{"id":"833d8ece.ff5ad8","type":"inject","z":"807487aa.61868","name":"TestMT1","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"x":180,"y":2080,"wires":[["33428e4a.36cf02"]]},{"id":"33428e4a.36cf02","type":"function","z":"807487aa.61868","name":"CreateMT1","func":"var mes = { MT1: {\n    emisor: 'monitor_test',\n    receptor: 'tienda_test',\n    time: {\n        timestamp: 1000,\n        creador: 'clanjhoo.com:1880'\n    },\n    listaP: {\n        producto: [\n            {\n                nombre: 'n1',\n                cantidad: 3\n            },\n            {\n                nombre: 'n2',\n                cantidad: 3\n            }\n        ]\n    }\n}};\n\nmsg.payload = mes;\nreturn msg;","outputs":1,"noerr":0,"x":190,"y":2160,"wires":[["86590a5.e7fdc78"]]},{"id":"86590a5.e7fdc78","type":"xml","z":"807487aa.61868","name":"MT1ToXMLTest","attr":"","chr":"","x":380,"y":2160,"wires":[["b43fb3f1.33b4f8"]]},{"id":"b43fb3f1.33b4f8","type":"http request","z":"807487aa.61868","name":"SendMT1","method":"POST","ret":"txt","url":"localhost:1880","tls":"","x":560,"y":2160,"wires":[["5e189020.56239"]]},{"id":"5e189020.56239","type":"debug","z":"807487aa.61868","name":"Print Response","active":true,"console":"false","complete":"true","x":760,"y":2160,"wires":[]},{"id":"d3188f06.67a96","type":"debug","z":"807487aa.61868","name":"CatchedError","active":true,"console":"false","complete":"error","x":2060,"y":780,"wires":[]},{"id":"ce6bae8f.fb66a","type":"http request","z":"807487aa.61868","name":"SendDuplicate","method":"POST","ret":"txt","url":"","tls":"","x":2080,"y":1620,"wires":[["46b29094.41efc"]]},{"id":"6d91a05f.ea87d8","type":"function","z":"807487aa.61868","name":"toMon","func":"msg.url = flow.get(\"monitor\");\nreturn msg;","outputs":1,"noerr":0,"x":1910,"y":1620,"wires":[["ce6bae8f.fb66a"]]},{"id":"46b29094.41efc","type":"debug","z":"807487aa.61868","name":"MonResponse","active":false,"console":"false","complete":"payload","x":2160,"y":1560,"wires":[]}]